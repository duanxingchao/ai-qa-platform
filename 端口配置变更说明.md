# 🔌 端口配置变更说明

## 📋 **变更概述**

为避免企业环境中的端口冲突，已将所有服务端口修改为最低风险的企业级端口配置。

## 🔄 **端口变更对比**

### **变更前 (高风险端口)**
```
❌ 前端HTTP:   80    (几乎必定冲突)
❌ 前端HTTPS:  443   (几乎必定冲突)
⚠️ Redis:      6379  (可能冲突)
⚠️ 后端API:    8088  (相对安全)
⚠️ Prometheus: 9090  (可能冲突)
```

### **变更后 (最低风险端口)**
```
✅ 前端HTTP:   18080  (企业级安全端口)
✅ 前端HTTPS:  18443  (企业级安全端口)
✅ Redis:      16379  (企业级安全端口)
✅ 后端API:    18088  (企业级安全端口)
✅ Prometheus: 19090  (企业级安全端口)
```

## 🎯 **新的访问地址**

### **服务访问地址**
```bash
# 前端服务
前端页面:     http://您的服务器IP:18080
前端HTTPS:    https://您的服务器IP:18443

# 后端服务
后端API:      http://您的服务器IP:18088
API文档:      http://您的服务器IP:18088/docs

# 基础设施服务
Redis缓存:    您的服务器IP:16379
监控面板:     http://您的服务器IP:19090
```

### **健康检查命令**
```bash
# 后端API健康检查
curl http://localhost:18088/api/health

# 前端服务健康检查
curl http://localhost:18080/health

# 完整系统测试
curl http://localhost:18088/api/dashboard
```

## 📝 **已修改的文件**

### **Docker配置文件**
- ✅ `docker-compose.ubuntu18.yml` - 所有端口映射已更新
- ✅ `backend/Dockerfile.ubuntu18` - 无需修改 (容器内端口不变)
- ✅ `frontend/Dockerfile.ubuntu18` - 无需修改 (容器内端口不变)

### **部署脚本**
- ✅ `quick-deploy-with-proxy.sh` - 端口引用已更新
- ✅ `deploy-ubuntu18.sh` - 无需修改 (不涉及端口)
- ✅ `setup-proxy-environment.sh` - 无需修改 (不涉及端口)

### **文档文件**
- ✅ `完整部署操作手册.md` - 所有端口引用已更新
- ✅ `内网代理环境部署指南.md` - 所有端口引用已更新
- ✅ `Docker部署详细说明.md` - 无需修改 (示例文档)

### **应用配置**
- ✅ `backend/app/config.py` - CORS配置已添加新端口

## 🚀 **部署说明**

### **无需额外操作**
由于所有配置文件都已更新，您只需要按照原计划部署即可：

```bash
# 1. 克隆项目到公司服务器
git clone https://github.com/duanxingchao/ai-qa-platform.git
cd ai-qa-platform

# 2. 运行快速部署 (已使用新端口)
chmod +x quick-deploy-with-proxy.sh
./quick-deploy-with-proxy.sh

# 3. 访问系统 (使用新端口)
# 前端: http://您的服务器IP:18080
# 后端: http://您的服务器IP:18088
```

### **防火墙配置 (如果需要)**
```bash
# 开放新端口
sudo ufw allow 18080  # 前端HTTP
sudo ufw allow 18443  # 前端HTTPS
sudo ufw allow 18088  # 后端API

# 可选端口 (内部服务)
sudo ufw allow 16379  # Redis (如果需要外部访问)
sudo ufw allow 19090  # Prometheus (如果需要外部访问)
```

## 🔧 **容器端口映射详情**

### **Docker Compose端口映射**
```yaml
services:
  backend:
    ports:
      - "18088:8088"  # 外部18088 -> 容器内8088
  
  frontend:
    ports:
      - "18080:80"    # 外部18080 -> 容器内80
      - "18443:443"   # 外部18443 -> 容器内443
  
  redis:
    ports:
      - "16379:6379"  # 外部16379 -> 容器内6379
  
  prometheus:
    ports:
      - "19090:9090"  # 外部19090 -> 容器内9090
```

### **容器内部通信**
```bash
# 容器间通信仍使用原端口 (Docker网络内部)
backend -> redis:6379
frontend -> backend:8088
prometheus -> backend:8088
```

## ⚠️ **注意事项**

### **如果仍有端口冲突**
万一新端口仍有冲突，可以快速修改：

```bash
# 1. 检查端口占用
netstat -tuln | grep :18080
netstat -tuln | grep :18088

# 2. 如有冲突，修改为其他端口
# 编辑 docker-compose.ubuntu18.yml
# 将 18080 改为 28080 等其他端口

# 3. 重新部署
docker-compose -f docker-compose.ubuntu18.yml down
docker-compose -f docker-compose.ubuntu18.yml up -d
```

### **企业网络策略**
- 确认公司防火墙允许这些端口
- 如需域名访问，配置反向代理到这些端口
- 考虑使用公司内部DNS解析

## ✅ **优势总结**

### **安全性提升**
- ✅ 避免与系统服务冲突 (80, 443)
- ✅ 避免与常用服务冲突 (6379, 9090)
- ✅ 使用企业级端口段 (18xxx, 16xxx, 19xxx)

### **管理便利性**
- ✅ 端口有规律性，便于记忆
- ✅ 统一的端口前缀，便于管理
- ✅ 为未来扩展预留端口空间

### **兼容性保证**
- ✅ 容器内部端口不变，应用无需修改
- ✅ 容器间通信不受影响
- ✅ 所有功能保持完整

## 📞 **如需调整**

如果部署后发现端口仍有冲突，请告知具体冲突的端口，我可以为您快速调整到其他安全端口。

**推荐的备选端口方案：**
- 方案二：28xxx 系列 (28080, 28088, 28443, 26379, 29090)
- 方案三：30xxx 系列 (30080, 30088, 30443, 30379, 30090)

现在您可以放心部署，端口冲突风险已降到最低！ 🎉
