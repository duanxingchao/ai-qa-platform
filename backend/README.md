# ğŸš€ AIé—®ç­”å›æµæ•°æ®å¤„ç†å¹³å° - åç«¯æ¶æ„æ–‡æ¡£

## ğŸ“Š é¡¹ç›®æ¦‚è§ˆ

**AIé—®ç­”å›æµæ•°æ®å¤„ç†å¹³å°**æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„æ™ºèƒ½é—®ç­”æ•°æ®å¤„ç†ç³»ç»Ÿï¼Œé‡‡ç”¨ç°ä»£åŒ–å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œä¸“æ³¨äºå¤§è§„æ¨¡AIé—®ç­”æ•°æ®çš„é‡‡é›†ã€å¤„ç†ã€åˆ†æå’Œè¯„ä¼°ã€‚å¹³å°å…·å¤‡é«˜åº¦çš„å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œå®¹é”™èƒ½åŠ›ï¼Œä¸ºæœªæ¥æ¥å…¥æ›´å¤šå¤–éƒ¨AIæœåŠ¡æä¾›äº†åšå®çš„æ¶æ„åŸºç¡€ã€‚

### ğŸ¯ æ ¸å¿ƒä»·å€¼
- **æ•°æ®ç»Ÿä¸€å¤„ç†**: é›†ä¸­ç®¡ç†å¤šæºAIé—®ç­”æ•°æ®
- **æ™ºèƒ½åˆ†ç±»è¯„ä¼°**: è‡ªåŠ¨åŒ–é—®é¢˜åˆ†ç±»å’Œç­”æ¡ˆè´¨é‡è¯„åˆ†
- **å¯æ‰©å±•æ¶æ„**: æ”¯æŒæ— ç¼æ¥å…¥æ–°çš„AIæœåŠ¡
- **å®æ—¶ç›‘æ§**: å®Œå–„çš„æ•°æ®åŒæ­¥å’Œå¤„ç†çŠ¶æ€ç›‘æ§
- **ä¼ä¸šçº§å¯é æ€§**: é«˜å¯ç”¨ã€å®¹é”™é‡è¯•ã€å®Œå–„çš„å¼‚å¸¸å¤„ç†

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### ğŸ“ æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AIé—®ç­”æ•°æ®å¤„ç†å¹³å°                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“± å‰ç«¯åº”ç”¨å±‚ (Frontend)                                   â”‚
â”‚  â”œâ”€â”€ React/Vueåº”ç”¨                                          â”‚
â”‚  â”œâ”€â”€ æ•°æ®å¯è§†åŒ–å¤§å±                                         â”‚
â”‚  â””â”€â”€ ç®¡ç†åå°ç•Œé¢                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŒ APIç½‘å…³å±‚ (API Gateway)                                â”‚
â”‚  â”œâ”€â”€ Flask RESTful API                                     â”‚
â”‚  â”œâ”€â”€ JWTèº«ä»½è®¤è¯                                            â”‚
â”‚  â”œâ”€â”€ CORSè·¨åŸŸå¤„ç†                                          â”‚
â”‚  â””â”€â”€ è¯·æ±‚é™æµä¸ç›‘æ§                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš™ï¸ ä¸šåŠ¡æœåŠ¡å±‚ (Business Services)                         â”‚
â”‚  â”œâ”€â”€ æ•°æ®åŒæ­¥æœåŠ¡ (SyncService)                             â”‚
â”‚  â”œâ”€â”€ AIåˆ†ç±»æœåŠ¡ (ClassificationService)                    â”‚
â”‚  â”œâ”€â”€ ç­”æ¡ˆç”ŸæˆæœåŠ¡ (AnswerGenerationService)                â”‚
â”‚  â”œâ”€â”€ è¯„åˆ†è¯„ä¼°æœåŠ¡ (ScoreService)                           â”‚
â”‚  â””â”€â”€ å®¡æ ¸ç®¡ç†æœåŠ¡ (ReviewService)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”Œ å¤–éƒ¨APIé›†æˆå±‚ (External API Integration)               â”‚
â”‚  â”œâ”€â”€ åˆ†ç±»APIå®¢æˆ·ç«¯ (ClassificationAPIClient)               â”‚
â”‚  â”œâ”€â”€ è±†åŒ…AIå®¢æˆ·ç«¯ (DoubaoAPIClient)                        â”‚
â”‚  â”œâ”€â”€ å°å¤©AIå®¢æˆ·ç«¯ (XiaotianAPIClient)                      â”‚
â”‚  â”œâ”€â”€ è¯„åˆ†APIå®¢æˆ·ç«¯ (ScoreAPIClient)                        â”‚
â”‚  â””â”€â”€ ç»Ÿä¸€APIå®¢æˆ·ç«¯åŸºç±» (BaseAPIClient)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¾ æ•°æ®æŒä¹…å±‚ (Data Persistence)                          â”‚
â”‚  â”œâ”€â”€ PostgreSQLä¸»æ•°æ®åº“                                    â”‚
â”‚  â”œâ”€â”€ SQLAlchemy ORM                                        â”‚
â”‚  â”œâ”€â”€ æ•°æ®æ¨¡å‹ç®¡ç†                                           â”‚
â”‚  â””â”€â”€ æ•°æ®åº“è¿æ¥æ±                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š åŸºç¡€è®¾æ–½å±‚ (Infrastructure)                             â”‚
â”‚  â”œâ”€â”€ å®šæ—¶ä»»åŠ¡è°ƒåº¦ (APScheduler)                            â”‚
â”‚  â”œâ”€â”€ æ—¥å¿—ç³»ç»Ÿ (Logging)                                    â”‚
â”‚  â”œâ”€â”€ å¼‚å¸¸å¤„ç†æœºåˆ¶                                           â”‚
â”‚  â”œâ”€â”€ æ€§èƒ½ç›‘æ§                                              â”‚
â”‚  â””â”€â”€ é…ç½®ç®¡ç†                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¨ æ ¸å¿ƒæ¶æ„ç‰¹è‰²

#### 1. **åˆ†å±‚æ¶æ„è®¾è®¡ (Layered Architecture)**
```python
ğŸ“ app/
â”œâ”€â”€ ğŸŒ api/           # APIè¡¨ç°å±‚ - RESTfulæ¥å£
â”œâ”€â”€ âš™ï¸ services/      # ä¸šåŠ¡é€»è¾‘å±‚ - æ ¸å¿ƒä¸šåŠ¡å¤„ç†
â”œâ”€â”€ ğŸ“Š models/        # æ•°æ®æ¨¡å‹å±‚ - ORMå®ä½“å®šä¹‰
â”œâ”€â”€ ğŸ”§ utils/         # å·¥å…·å±‚ - é€šç”¨å·¥å…·å‡½æ•°
â””â”€â”€ âš ï¸ exceptions/    # å¼‚å¸¸å±‚ - ç»Ÿä¸€å¼‚å¸¸å¤„ç†
```

#### 2. **æ¨¡å—åŒ–è“å›¾è®¾è®¡ (Blueprint Pattern)**
- **åŒæ­¥æ¨¡å—** (`sync_bp`): æ•°æ®åŒæ­¥ç®¡ç†
- **é—®é¢˜æ¨¡å—** (`question_bp`): é—®é¢˜æŸ¥è¯¢å¤„ç†
- **å¤„ç†æ¨¡å—** (`process_bp`): æ•°æ®å¤„ç†æµç¨‹
- **å®¡æ ¸æ¨¡å—** (`review_bp`): å®¡æ ¸çŠ¶æ€ç®¡ç†

#### 3. **åº”ç”¨å·¥å‚æ¨¡å¼ (Application Factory)**
```python
def create_app(config_name=None):
    """åº”ç”¨å·¥å‚å‡½æ•° - æ”¯æŒå¤šç¯å¢ƒé…ç½®"""
    app = Flask(__name__)
    app.config.from_object(config[config_name])
    
    # æ¨¡å—åŒ–åˆå§‹åŒ–
    init_extensions(app)      # æ‰©å±•åˆå§‹åŒ–
    register_blueprints(app)  # è“å›¾æ³¨å†Œ
    configure_logging(app)    # æ—¥å¿—é…ç½®
    init_scheduler(app)       # å®šæ—¶ä»»åŠ¡
    
    return app
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆé€‰å‹

### ğŸ“š æ ¸å¿ƒæŠ€æœ¯æ ˆ
| æŠ€æœ¯æ ˆ | ç‰ˆæœ¬ | é€‰æ‹©ç†ç”± |
|--------|------|----------|
| **Flask** | 2.3.2 | è½»é‡çº§ã€çµæ´»ã€é€‚åˆå¾®æœåŠ¡æ¶æ„ |
| **SQLAlchemy** | 2.0.19 | æˆç†Ÿçš„ORMã€æ”¯æŒå¤šæ•°æ®åº“ã€æ€§èƒ½ä¼˜ç§€ |
| **PostgreSQL** | 14+ | ä¼ä¸šçº§æ•°æ®åº“ã€æ”¯æŒå¤æ‚æŸ¥è¯¢ã€é«˜å¹¶å‘ |
| **APScheduler** | 3.10.1 | å¼ºå¤§çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦ã€æ”¯æŒæŒä¹…åŒ– |
| **Flask-JWT-Extended** | 4.5.2 | å®‰å…¨çš„JWTè®¤è¯ã€æ”¯æŒåˆ·æ–°token |
| **Requests** | 2.31.0 | HTTPå®¢æˆ·ç«¯ã€æ”¯æŒè¿æ¥æ± ã€é‡è¯•æœºåˆ¶ |
| **Gunicorn** | 21.2.0 | ç”Ÿäº§çº§WSGIæœåŠ¡å™¨ã€æ”¯æŒå¤šè¿›ç¨‹ |

### ğŸ† æ¶æ„ä¼˜åŠ¿åˆ†æ

#### 1. **é«˜å¯æ‰©å±•æ€§è®¾è®¡**
- **å¾®æœåŠ¡å‹å¥½**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‹†åˆ†ä¸ºç‹¬ç«‹æœåŠ¡
- **æ’ä»¶åŒ–APIå®¢æˆ·ç«¯**: æ–°å¢AIæœåŠ¡åªéœ€å®ç°`BaseAPIClient`æ¥å£
- **é…ç½®é©±åŠ¨**: é€šè¿‡ç¯å¢ƒå˜é‡çµæ´»é…ç½®ä¸åŒç¯å¢ƒ

#### 2. **ä¼ä¸šçº§å¯é æ€§**
- **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**: 8ç§ä¸“ç”¨å¼‚å¸¸ç±»å‹ï¼Œç²¾ç¡®é”™è¯¯å®šä½
- **è‡ªåŠ¨é‡è¯•æœºåˆ¶**: æŒ‡æ•°é€€é¿ç®—æ³•ï¼Œæ™ºèƒ½ç½‘ç»œå®¹é”™
- **äº‹åŠ¡ä¸€è‡´æ€§**: æ•°æ®åº“æ“ä½œåŸå­æ€§ä¿è¯
- **å®Œå–„æ—¥å¿—ä½“ç³»**: ç»“æ„åŒ–æ—¥å¿—ï¼Œä¾¿äºé—®é¢˜è¿½è¸ª

#### 3. **é«˜æ€§èƒ½ä¼˜åŒ–**
- **è¿æ¥æ± ç®¡ç†**: SQLAlchemyè¿æ¥æ± ï¼Œå‡å°‘è¿æ¥å¼€é”€
- **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡æ•°æ®å¤„ç†ï¼Œæå‡ååé‡
- **å¼‚æ­¥å®šæ—¶ä»»åŠ¡**: åå°ä»»åŠ¡ä¸é˜»å¡ä¸»ä¸šåŠ¡æµç¨‹
- **SQLä¼˜åŒ–**: åˆç†ç´¢å¼•è®¾è®¡ï¼ŒæŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### ğŸ—„ï¸ æ ¸å¿ƒæ•°æ®è¡¨

#### 1. **Questionsè¡¨** - é—®é¢˜ä¸»è¡¨
```sql
CREATE TABLE questions (
    id SERIAL PRIMARY KEY,
    business_id VARCHAR(64) UNIQUE NOT NULL,  -- MD5ä¸šåŠ¡ä¸»é”®
    pageid VARCHAR(100),                      -- é¡µé¢ID
    devicetypename VARCHAR(50),               -- è®¾å¤‡ç±»å‹
    query TEXT NOT NULL,                      -- é—®é¢˜å†…å®¹
    sendmessagetime TIMESTAMP,                -- å‘é€æ—¶é—´
    classification VARCHAR(50),               -- AIåˆ†ç±»ç»“æœ
    processing_status VARCHAR(20) DEFAULT 'pending',  -- å¤„ç†çŠ¶æ€
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 2. **Answersè¡¨** - ç­”æ¡ˆè¡¨
```sql
CREATE TABLE answers (
    id SERIAL PRIMARY KEY,
    question_business_id VARCHAR(64) NOT NULL, -- å…³è”é—®é¢˜
    answer_text TEXT,                          -- ç­”æ¡ˆå†…å®¹
    assistant_type VARCHAR(50) NOT NULL,       -- AIç±»å‹(original/doubao/xiaotian)
    is_scored BOOLEAN DEFAULT FALSE,           -- æ˜¯å¦å·²è¯„åˆ†
    answer_time TIMESTAMP,
    FOREIGN KEY (question_business_id) REFERENCES questions(business_id)
);
```

#### 3. **Scoresè¡¨** - äº”ç»´è¯„åˆ†è¡¨
```sql
CREATE TABLE scores (
    id SERIAL PRIMARY KEY,
    answer_id INTEGER NOT NULL,
    score_1 INTEGER CHECK (score_1 >= 1 AND score_1 <= 5),  -- å‡†ç¡®æ€§
    score_2 INTEGER CHECK (score_2 >= 1 AND score_2 <= 5),  -- å®Œæ•´æ€§
    score_3 INTEGER CHECK (score_3 >= 1 AND score_3 <= 5),  -- æ¸…æ™°åº¦
    score_4 INTEGER CHECK (score_4 >= 1 AND score_4 <= 5),  -- å®ç”¨æ€§
    score_5 INTEGER CHECK (score_5 >= 1 AND score_5 <= 5),  -- åˆ›æ–°æ€§
    average_score DECIMAL(3,2),                              -- å¹³å‡åˆ†
    comment TEXT,                                            -- è¯„åˆ†ç†ç”±
    FOREIGN KEY (answer_id) REFERENCES answers(id)
);
```

### ğŸ”— æ•°æ®å…³ç³»è®¾è®¡
```
table1 (åŸå§‹æ•°æ®)
    â†“ æ•°æ®åŒæ­¥
questions (é—®é¢˜è¡¨) â†â†’ answers (ç­”æ¡ˆè¡¨)
    â†“                      â†“
review_status          scores (è¯„åˆ†è¡¨)
(å®¡æ ¸çŠ¶æ€è¡¨)
```

## âš¡ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### ğŸ”„ æ•°æ®åŒæ­¥æµç¨‹
```mermaid
graph TD
    A[table1åŸå§‹æ•°æ®] --> B[SyncServiceæ•°æ®åŒæ­¥]
    B --> C{æ•°æ®éªŒè¯}
    C -->|æœ‰æ•ˆ| D[ç”Ÿæˆbusiness_id]
    C -->|æ— æ•ˆ| E[è·³è¿‡è®°å½•]
    D --> F[åŒæ­¥åˆ°questionsè¡¨]
    D --> G[åŒæ­¥åˆ°answersè¡¨]
    F --> H[æ›´æ–°åŒæ­¥çŠ¶æ€]
    G --> H
    H --> I[å®šæ—¶ä»»åŠ¡ç­‰å¾…]
    I --> B
```

**æ ¸å¿ƒç‰¹è‰²**ï¼š
- **å¢é‡åŒæ­¥**: åŸºäºæ—¶é—´æˆ³çš„å¢é‡æ•°æ®åŒæ­¥
- **æ•°æ®éªŒè¯**: SQLå±‚é¢è¿‡æ»¤ç©ºæŸ¥è¯¢è®°å½•
- **ä¸šåŠ¡ä¸»é”®**: MD5å“ˆå¸Œç¡®ä¿æ•°æ®å”¯ä¸€æ€§
- **åŸå­æ“ä½œ**: äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

### ğŸ¤– AIå¤„ç†æµç¨‹
```mermaid
graph TD
    A[æ–°é—®é¢˜æ•°æ®] --> B[é—®é¢˜åˆ†ç±»API]
    B --> C[åˆ†ç±»ç»“æœå­˜å‚¨]
    A --> D[è±†åŒ…AIç”Ÿæˆç­”æ¡ˆ]
    A --> E[å°å¤©AIç”Ÿæˆç­”æ¡ˆ]
    D --> F[ç­”æ¡ˆè´¨é‡è¯„åˆ†]
    E --> F
    F --> G[äº”ç»´è¯„åˆ†å­˜å‚¨]
    G --> H[äººå·¥å®¡æ ¸]
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- **å¹¶è¡Œå¤„ç†**: å¤šAIæœåŠ¡å¹¶è¡Œç”Ÿæˆç­”æ¡ˆ
- **ç»Ÿä¸€å®¢æˆ·ç«¯**: `BaseAPIClient`ç»Ÿä¸€APIè°ƒç”¨è§„èŒƒ
- **å®¹é”™è®¾è®¡**: è‡ªåŠ¨é‡è¯•+ç†”æ–­æœºåˆ¶
- **æ€§èƒ½ç›‘æ§**: å®Œæ•´çš„APIè°ƒç”¨ç»Ÿè®¡

## ğŸ¯ æŠ€æœ¯åˆ›æ–°äº®ç‚¹

### 1. **ç»Ÿä¸€APIå®¢æˆ·ç«¯æ¶æ„**
```python
class BaseAPIClient(ABC):
    """
    ä¼ä¸šçº§APIå®¢æˆ·ç«¯åŸºç±»
    
    ğŸš€ æ ¸å¿ƒç‰¹æ€§:
    - è‡ªåŠ¨é‡è¯•æœºåˆ¶ (æŒ‡æ•°é€€é¿)
    - å®Œå–„çš„é”™è¯¯å¤„ç† (8ç§å¼‚å¸¸ç±»å‹)
    - è¯·æ±‚/å“åº”æ—¥å¿—è®°å½•
    - æ€§èƒ½ç»Ÿè®¡ç›‘æ§
    - è¿æ¥æ± ç®¡ç†
    """
    
    def _make_request_with_retry(self, method, url, data=None):
        """å¸¦é‡è¯•çš„HTTPè¯·æ±‚"""
        for attempt in range(self.retry_times + 1):
            try:
                response = self.session.request(...)
                return response
            except (ConnectionError, Timeout) as e:
                if attempt < self.retry_times:
                    # æŒ‡æ•°é€€é¿ç®—æ³•
                    delay = self.retry_delay * (self.backoff_factor ** attempt)
                    time.sleep(delay)
                    continue
                else:
                    raise e
```

### 2. **æ™ºèƒ½å¼‚å¸¸å¤„ç†ä½“ç³»**
```python
# ç²¾ç»†åŒ–å¼‚å¸¸åˆ†ç±»
APITimeoutException      # è¶…æ—¶å¼‚å¸¸
APIConnectionException   # è¿æ¥å¼‚å¸¸  
APIRateLimitException    # é™æµå¼‚å¸¸
APIAuthenticationException # è®¤è¯å¼‚å¸¸
APIValidationException   # å‚æ•°éªŒè¯å¼‚å¸¸
APIServerException       # æœåŠ¡å™¨å¼‚å¸¸
APIResponseException     # å“åº”æ ¼å¼å¼‚å¸¸
```

### 3. **ä¼˜é›…çš„å®šæ—¶ä»»åŠ¡è®¾è®¡**
```python
def init_scheduler(app):
    """å®šæ—¶ä»»åŠ¡åˆå§‹åŒ–"""
    scheduler = BackgroundScheduler()
    
    # æ•°æ®åŒæ­¥ä»»åŠ¡
    scheduler.add_job(
        func=lambda: sync_data_task(app),
        trigger='interval',
        minutes=app.config['SYNC_INTERVAL_MINUTES'],
        id='sync_data_job',
        replace_existing=True
    )
    
    # ä¼˜é›…å…³é—­
    atexit.register(lambda: scheduler.shutdown())
```

### 4. **ä¸šåŠ¡ä¸»é”®ç”Ÿæˆç­–ç•¥**
```python
def generate_business_id(pageid, sendmessagetime, query):
    """
    MD5ä¸šåŠ¡ä¸»é”®ç”Ÿæˆ
    - ç¡®ä¿ç›¸åŒé—®é¢˜çš„å”¯ä¸€æ€§
    - æ”¯æŒåˆ†å¸ƒå¼ç¯å¢ƒ
    - é¿å…æ•°æ®é‡å¤
    """
    data_str = f"{pageid}_{time_str}_{query_str}"
    return hashlib.md5(data_str.encode('utf-8')).hexdigest()
```

## ğŸš¦ å½“å‰å¼€å‘è¿›åº¦

### âœ… å·²å®ŒæˆåŠŸèƒ½ (90%+)

#### ğŸ—ï¸ **æ¶æ„åŸºç¡€** (100%)
- âœ… Flaskåº”ç”¨å·¥å‚æ¨¡å¼
- âœ… åˆ†å±‚æ¶æ„è®¾è®¡
- âœ… æ¨¡å—åŒ–è“å›¾ç»„ç»‡
- âœ… é…ç½®ç®¡ç†ç³»ç»Ÿ
- âœ… å¼‚å¸¸å¤„ç†æ¡†æ¶

#### ğŸ“Š **æ•°æ®å±‚** (95%)
- âœ… PostgreSQLæ•°æ®åº“è®¾è®¡
- âœ… SQLAlchemy ORMæ¨¡å‹
- âœ… æ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… ç´¢å¼•ä¼˜åŒ–
- âœ… ä¸šåŠ¡ä¸»é”®ç”Ÿæˆ

#### ğŸ”„ **æ•°æ®åŒæ­¥æœåŠ¡** (95%)
- âœ… å¢é‡æ•°æ®åŒæ­¥
- âœ… åŒè¡¨åˆ†ç¦»åŒæ­¥ (questions/answers)
- âœ… æ•°æ®éªŒè¯è¿‡æ»¤
- âœ… åŒæ­¥çŠ¶æ€ç›‘æ§
- âœ… å®šæ—¶ä»»åŠ¡è°ƒåº¦

#### ğŸ¤– **AIæœåŠ¡é›†æˆ** (85%)
- âœ… ç»Ÿä¸€APIå®¢æˆ·ç«¯åŸºç±»
- âœ… åˆ†ç±»APIé›†æˆ
- âœ… è±†åŒ…AIé›†æˆ
- âœ… å°å¤©AIé›†æˆ
- âœ… è¯„åˆ†APIé›†æˆ
- âœ… å®¹é”™é‡è¯•æœºåˆ¶

#### ğŸŒ **APIæ¥å£å±‚** (80%)
- âœ… åŒæ­¥ç®¡ç†API
- âœ… æ•°æ®æŸ¥è¯¢API
- âœ… çŠ¶æ€ç›‘æ§API
- âœ… JWTè®¤è¯ä½“ç³»
- âœ… CORSè·¨åŸŸæ”¯æŒ

#### ğŸ§ª **æµ‹è¯•ä½“ç³»** (90%)
- âœ… å®Œæ•´çš„æµ‹è¯•æ¶æ„
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–
- âœ… APIé›†æˆæµ‹è¯•
- âœ… æ•°æ®åº“æµ‹è¯•
- âœ… Mockæ•°æ®ç®¡ç†

### ğŸš§ å¼€å‘ä¸­åŠŸèƒ½ (10%)

#### ğŸ“ˆ **ä¸šåŠ¡å¤„ç†æµç¨‹** (30%)
- ğŸ”„ æ‰¹é‡é—®é¢˜åˆ†ç±»å¤„ç†
- ğŸ”„ AIç­”æ¡ˆç”Ÿæˆæµç¨‹
- ğŸ”„ è¯„åˆ†å¤„ç†æµç¨‹
- â³ å®¡æ ¸å·¥ä½œæµ

#### ğŸ“Š **ç®¡ç†åå°** (20%)
- â³ æ•°æ®ç»Ÿè®¡å¤§å±
- â³ åŒæ­¥çŠ¶æ€ç›‘æ§
- â³ AIæœåŠ¡æ€§èƒ½ç›‘æ§
- â³ å®¡æ ¸ç®¡ç†ç•Œé¢

#### ğŸ”§ **è¿ç»´åŠŸèƒ½** (40%)
- ğŸ”„ å¥åº·æ£€æŸ¥API
- ğŸ”„ æ€§èƒ½ç›‘æ§æŒ‡æ ‡
- â³ æ—¥å¿—åˆ†æ
- â³ æŠ¥è­¦é€šçŸ¥

### ğŸ¯ ä¸‹ä¸€é˜¶æ®µè§„åˆ’

#### ğŸ“Š **æ•°æ®å¤„ç†æµç¨‹ä¼˜åŒ–**
- å®ç°æ‰¹é‡AIè°ƒç”¨å¤„ç†
- ä¼˜åŒ–å¤§æ•°æ®é‡å¤„ç†æ€§èƒ½
- æ·»åŠ æ•°æ®è´¨é‡ç›‘æ§

#### ğŸ”§ **è¿ç»´ç›‘æ§å®Œå–„**  
- å®Œå–„å¥åº·æ£€æŸ¥æœºåˆ¶
- æ·»åŠ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- å®ç°æŠ¥è­¦é€šçŸ¥ç³»ç»Ÿ

#### ğŸ¨ **å‰ç«¯ç®¡ç†ç•Œé¢**
- å¼€å‘æ•°æ®å¯è§†åŒ–å¤§å±
- å®ç°å®æ—¶ç›‘æ§ç•Œé¢
- æ„å»ºå®¡æ ¸ç®¡ç†å·¥å…·

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ğŸ“‹ ç¯å¢ƒè¦æ±‚
- Python 3.8+
- PostgreSQL 12+
- Redis 6+ (å¯é€‰)

### âš™ï¸ å®‰è£…æ­¥éª¤

#### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd backend

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

#### 2. é…ç½®ç¯å¢ƒ
```bash
# å¤åˆ¶ç¯å¢ƒé…ç½®
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env
```

**å…³é”®é…ç½®é¡¹**ï¼š
```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:password@localhost:5432/ai_qa_platform

# å¤–éƒ¨APIé…ç½®
CLASSIFY_API_URL=http://localhost:8001
CLASSIFY_API_KEY=your-api-key

DOUBAO_API_URL=http://api.example.com/api/doubao
DOUBAO_API_KEY=your-doubao-key

XIAOTIAN_API_URL=http://api.example.com/api/xiaotian
XIAOTIAN_API_KEY=your-xiaotian-key

SCORE_API_URL=http://api.example.com/api/score
SCORE_API_KEY=your-score-key

# å®‰å…¨é…ç½®
SECRET_KEY=your-secret-key
JWT_SECRET_KEY=your-jwt-secret
```

#### 3. åˆå§‹åŒ–æ•°æ®åº“
```bash
# åˆå§‹åŒ–æ•°æ®åº“è¡¨
python init_db.py
```

#### 4. å¯åŠ¨æœåŠ¡
```bash
# å¼€å‘æ¨¡å¼
python run.py

# ç”Ÿäº§æ¨¡å¼
gunicorn -w 4 -b 0.0.0.0:5000 run:app
```

### ğŸ§ª è¿è¡Œæµ‹è¯•
```bash
# è¿›å…¥æµ‹è¯•ç›®å½•
cd tests

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
python run_tests.py

# è¿è¡Œç‰¹å®šæµ‹è¯•
python test_core.py      # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
python test_api.py       # APIæ¥å£æµ‹è¯•
```

## ğŸ“Š APIæ–‡æ¡£

### ğŸ”„ æ•°æ®åŒæ­¥API

#### è·å–åŒæ­¥çŠ¶æ€
```http
GET /api/sync/status
```
**å“åº”ç¤ºä¾‹**ï¼š
```json
{
    "success": true,
    "data": {
        "last_sync_time": "2024-01-09T10:30:00Z",
        "total_synced": 1250,
        "questions_count": 1250,
        "answers_count": 980,
        "status": "idle"
    }
}
```

#### è§¦å‘æ‰‹åŠ¨åŒæ­¥
```http
POST /api/sync/trigger
Content-Type: application/json

{
    "force_full_sync": false
}
```

#### è·å–åŒæ­¥ç»Ÿè®¡
```http
GET /api/sync/statistics
```

### ğŸ¤– æ•°æ®å¤„ç†API

#### è§¦å‘é—®é¢˜åˆ†ç±»
```http
POST /api/process/classify
```

#### ç”ŸæˆAIç­”æ¡ˆ
```http
POST /api/process/generate
```

#### æ‰§è¡Œç­”æ¡ˆè¯„åˆ†
```http
POST /api/process/score
```

### ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

#### Pythonå®¢æˆ·ç«¯è°ƒç”¨
```python
import requests

# è·å–åŒæ­¥çŠ¶æ€
response = requests.get('http://localhost:5000/api/sync/status')
status = response.json()

# è§¦å‘æ•°æ®åŒæ­¥
sync_data = {'force_full_sync': False}
response = requests.post(
    'http://localhost:5000/api/sync/trigger',
    json=sync_data
)
```

#### curlå‘½ä»¤è°ƒç”¨
```bash
# è·å–åŒæ­¥çŠ¶æ€
curl -X GET http://localhost:5000/api/sync/status

# è§¦å‘åŒæ­¥
curl -X POST http://localhost:5000/api/sync/trigger \
     -H "Content-Type: application/json" \
     -d '{"force_full_sync": false}'
```

## ğŸ¯ æ¶æ„è®¾è®¡åŸåˆ™

### ğŸ† SOLIDåŸåˆ™å®è·µ
- **å•ä¸€èŒè´£**: æ¯ä¸ªæœåŠ¡ç±»ä¸“æ³¨å•ä¸€ä¸šåŠ¡åŠŸèƒ½
- **å¼€é—­åŸåˆ™**: é€šè¿‡æ¥å£æ‰©å±•ï¼Œå¯¹ä¿®æ”¹å…³é—­
- **é‡Œæ°æ›¿æ¢**: APIå®¢æˆ·ç«¯å¯æ— ç¼æ›¿æ¢
- **æ¥å£éš”ç¦»**: ç²¾ç»†åŒ–æ¥å£è®¾è®¡
- **ä¾èµ–å€’ç½®**: ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°

### ğŸ”§ è®¾è®¡æ¨¡å¼åº”ç”¨
- **å·¥å‚æ¨¡å¼**: åº”ç”¨å·¥å‚ã€APIå®¢æˆ·ç«¯å·¥å‚
- **å•ä¾‹æ¨¡å¼**: æ•°æ®åº“è¿æ¥ã€APIå®¢æˆ·ç«¯å®ä¾‹
- **ç­–ç•¥æ¨¡å¼**: ä¸åŒAIæœåŠ¡çš„å¤„ç†ç­–ç•¥
- **è§‚å¯Ÿè€…æ¨¡å¼**: äº‹ä»¶é©±åŠ¨çš„çŠ¶æ€æ›´æ–°
- **è£…é¥°å™¨æ¨¡å¼**: é‡è¯•ã€æ—¥å¿—ã€è®¤è¯è£…é¥°

### ğŸ›¡ï¸ å®¹é”™è®¾è®¡
- **ä¼˜é›…é™çº§**: APIæœåŠ¡ä¸å¯ç”¨æ—¶çš„å¤‡é€‰æ–¹æ¡ˆ
- **ç†”æ–­æœºåˆ¶**: é˜²æ­¢é›ªå´©æ•ˆåº”
- **è¶…æ—¶æ§åˆ¶**: é¿å…é•¿æ—¶é—´é˜»å¡
- **é‡è¯•ç­–ç•¥**: æ™ºèƒ½é‡è¯•ç®—æ³•
- **æ•°æ®ä¸€è‡´æ€§**: äº‹åŠ¡å›æ»šä¿è¯

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ğŸš€ æ•°æ®åº“ä¼˜åŒ–
```sql
-- å…³é”®ç´¢å¼•è®¾è®¡
CREATE INDEX idx_questions_sendmessagetime ON questions(sendmessagetime);
CREATE INDEX idx_questions_classification ON questions(classification);
CREATE INDEX idx_questions_processing_status ON questions(processing_status);
CREATE INDEX idx_answers_question_business_id ON answers(question_business_id);
CREATE INDEX idx_answers_assistant_type ON answers(assistant_type);
```

### âš¡ åº”ç”¨å±‚ä¼˜åŒ–
- **è¿æ¥æ± **: SQLAlchemyè¿æ¥æ± é…ç½®
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡æ’å…¥å’Œæ›´æ–°
- **ç¼“å­˜ç­–ç•¥**: Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
- **å¼‚æ­¥å¤„ç†**: åå°ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ

### ğŸ“Š ç›‘æ§æŒ‡æ ‡
- **APIå“åº”æ—¶é—´**: å¹³å‡å“åº”æ—¶é—´ < 200ms
- **æ•°æ®åº“æŸ¥è¯¢**: å¤æ‚æŸ¥è¯¢ < 1s
- **åŒæ­¥æ•ˆç‡**: 1000æ¡/åˆ†é’Ÿ
- **é”™è¯¯ç‡**: < 0.1%

## ğŸ”® æœªæ¥æ‰©å±•è§„åˆ’

### ğŸŒŸ æŠ€æœ¯æ¼”è¿›è·¯çº¿

#### çŸ­æœŸç›®æ ‡ (1-3ä¸ªæœˆ)
- **å®Œå–„ä¸šåŠ¡æµç¨‹**: å®ç°å®Œæ•´çš„AIå¤„ç†é“¾è·¯
- **ä¼˜åŒ–æ€§èƒ½**: æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ã€ç¼“å­˜å¼•å…¥
- **ç›‘æ§å®Œå–„**: å®æ—¶ç›‘æ§å¤§å±ã€æŠ¥è­¦ç³»ç»Ÿ

#### ä¸­æœŸç›®æ ‡ (3-6ä¸ªæœˆ)  
- **å¾®æœåŠ¡åŒ–**: æœåŠ¡æ‹†åˆ†ã€å®¹å™¨åŒ–éƒ¨ç½²
- **æ¶ˆæ¯é˜Ÿåˆ—**: å¼•å…¥RabbitMQ/Kafkaå¤„ç†é«˜å¹¶å‘
- **åˆ†å¸ƒå¼ç¼“å­˜**: Redisé›†ç¾¤ã€ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

#### é•¿æœŸç›®æ ‡ (6-12ä¸ªæœˆ)
- **äº‘åŸç”Ÿ**: Kuberneteséƒ¨ç½²ã€è‡ªåŠ¨æ‰©ç¼©å®¹
- **å¤§æ•°æ®å¤„ç†**: Spark/Flinkå¤„ç†æµ·é‡æ•°æ®  
- **AIæ¨¡å‹é›†æˆ**: è‡ªç ”AIæ¨¡å‹æ¥å…¥
- **å®æ—¶åˆ†æ**: æµå¼æ•°æ®å¤„ç†ã€å®æ—¶æŠ¥è¡¨

### ğŸ”Œ æ–°AIæœåŠ¡æ¥å…¥æŒ‡å—

è¦æ¥å…¥æ–°çš„AIæœåŠ¡ï¼Œåªéœ€è¦ï¼š

#### 1. åˆ›å»ºAPIå®¢æˆ·ç«¯
```python
class NewAIAPIClient(BaseAPIClient):
    """æ–°AIæœåŠ¡å®¢æˆ·ç«¯"""
    
    def __init__(self):
        super().__init__(
            base_url=Config.NEW_AI_API_URL,
            api_key=Config.NEW_AI_API_KEY
        )
    
    def _get_auth_headers(self) -> Dict[str, str]:
        return {'Authorization': f'Bearer {self.api_key}'}
    
    def generate_answer(self, question: str) -> Dict[str, Any]:
        return self.post('/answer', data={'question': question})
```

#### 2. æ›´æ–°é…ç½®
```python
# config.py
NEW_AI_API_URL = os.environ.get('NEW_AI_API_URL')
NEW_AI_API_KEY = os.environ.get('NEW_AI_API_KEY')
```

#### 3. æ³¨å†Œåˆ°å·¥å‚
```python
# APIClientFactory
@classmethod
def get_new_ai_client(cls) -> NewAIAPIClient:
    if 'new_ai' not in cls._instances:
        cls._instances['new_ai'] = NewAIAPIClient()
    return cls._instances['new_ai']
```

### ğŸ¯ å¯æ‰©å±•æ€§ä¿è¯
- **ç»Ÿä¸€æ¥å£**: æ‰€æœ‰AIæœåŠ¡éµå¾ªç›¸åŒæ¥å£è§„èŒƒ
- **é…ç½®é©±åŠ¨**: æ–°æœåŠ¡é…ç½®åŒ–æ¥å…¥ï¼Œæ— éœ€ä»£ç ä¿®æ”¹
- **æ’ä»¶æ¶æ„**: æ”¯æŒçƒ­æ’æ‹”å¼æœåŠ¡é›†æˆ
- **ç‰ˆæœ¬ç®¡ç†**: APIç‰ˆæœ¬åŒ–ï¼Œå‘åå…¼å®¹

## ğŸ¤ å¼€å‘æŒ‡å—

### ğŸ“ ä»£ç è§„èŒƒ
- **PEP 8**: Pythonä»£ç é£æ ¼æ ‡å‡†
- **ç±»å‹æ³¨è§£**: ä½¿ç”¨typingæ¨¡å—æ ‡æ³¨ç±»å‹
- **æ–‡æ¡£å­—ç¬¦ä¸²**: å®Œæ•´çš„docstringæ–‡æ¡£
- **å•å…ƒæµ‹è¯•**: è¦†ç›–ç‡ > 80%

### ğŸ”§ å¼€å‘å·¥å…·
```bash
# ä»£ç æ ¼å¼åŒ–
black app/

# ä»£ç æ£€æŸ¥
flake8 app/

# ç±»å‹æ£€æŸ¥
mypy app/

# æµ‹è¯•è¦†ç›–ç‡
pytest --cov=app tests/
```

### ğŸ“š å‚è€ƒæ–‡æ¡£
- **Flaskå®˜æ–¹æ–‡æ¡£**: [Flask Documentation](https://flask.palletsprojects.com/)
- **SQLAlchemyæ–‡æ¡£**: [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- **PostgreSQLæ–‡æ¡£**: [PostgreSQL Documentation](https://www.postgresql.org/docs/)

---

## ğŸ“„ æ€»ç»“

è¿™ä¸ª**AIé—®ç­”å›æµæ•°æ®å¤„ç†å¹³å°**ä»£è¡¨äº†ç°ä»£ä¼ä¸šçº§åº”ç”¨çš„æœ€ä½³å®è·µï¼Œå…·å¤‡ï¼š

- ğŸ—ï¸ **ä¼˜ç§€çš„æ¶æ„è®¾è®¡**: åˆ†å±‚æ¶æ„ã€æ¨¡å—åŒ–ã€å¯æ‰©å±•
- ğŸ›¡ï¸ **ä¼ä¸šçº§å¯é æ€§**: å®¹é”™æœºåˆ¶ã€å¼‚å¸¸å¤„ç†ã€äº‹åŠ¡ä¸€è‡´æ€§  
- âš¡ **é«˜æ€§èƒ½ä¼˜åŒ–**: è¿æ¥æ± ã€æ‰¹å¤„ç†ã€ç´¢å¼•ä¼˜åŒ–
- ğŸ”§ **å®Œå–„çš„è¿ç»´**: æ—¥å¿—ç›‘æ§ã€å¥åº·æ£€æŸ¥ã€æ€§èƒ½ç»Ÿè®¡
- ğŸš€ **æŠ€æœ¯å‰ç»æ€§**: äº‘åŸç”Ÿå°±ç»ªã€å¾®æœåŠ¡å‹å¥½

è¿™æ˜¯ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šçš„**ç”Ÿäº§å°±ç»ª**ç³»ç»Ÿï¼Œä¸ºAIé—®ç­”æ•°æ®å¤„ç†æä¾›äº†åšå®å¯é çš„æŠ€æœ¯åº•åº§ï¼

---

*ğŸ’¡ å¦‚æœ‰ä»»ä½•æŠ€æœ¯é—®é¢˜æˆ–æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿æäº¤Issueæˆ–PRï¼* 