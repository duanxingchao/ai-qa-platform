# 🌐 内网代理环境部署指南

## 📋 **部署前准备**

### **必需信息清单**
```bash
# 1. 代理服务器信息
代理服务器地址: http://proxy-server:port
代理用户名: _________________ (如果需要认证)
代理密码: ___________________ (如果需要认证)

# 2. 服务器信息
服务器IP: ___________________
SSH用户名: _________________
SSH密码/密钥: ______________

# 3. 高斯数据库信息
数据库地址: ________________
数据库端口: 5432 (默认)
数据库名: __________________
用户名: ____________________
密码: ______________________

# 4. 外部API信息 (可选)
分类API地址: _______________
分类API密钥: _______________
AI生成API地址: _____________
AI生成API密钥: _____________
```

## 🚀 **完整部署流程**

### **阶段一：代理环境配置 (15分钟)**

#### **步骤1: 连接服务器**
```bash
# 1.1 SSH连接到公司服务器
ssh your-username@your-server-ip

# 1.2 确认系统版本
cat /etc/os-release
# 应该显示 Ubuntu 18.04
```

#### **步骤2: 下载项目代码**
```bash
# 2.1 临时设置代理（用于git clone）
export http_proxy=http://您的代理服务器地址:端口
export https_proxy=http://您的代理服务器地址:端口

# 2.2 配置Git代理
git config --global http.proxy http://您的代理服务器地址:端口
git config --global https.proxy http://您的代理服务器地址:端口

# 2.3 克隆项目
git clone https://github.com/duanxingchao/ai-qa-platform.git

# 2.4 进入项目目录
cd ai-qa-platform

# 2.5 确认文件存在
ls -la setup-proxy-environment.sh deploy-ubuntu18.sh
```

#### **步骤3: 配置代理环境**
```bash
# 3.1 给脚本执行权限
chmod +x setup-proxy-environment.sh

# 3.2 运行代理配置脚本
./setup-proxy-environment.sh

# 按提示输入：
# - 代理服务器地址: http://proxy-server:port
# - 是否需要认证: y/n
# - 用户名和密码（如果需要）

# 3.3 重新加载环境变量
source ~/.bashrc

# 3.4 验证代理配置
echo $http_proxy
curl -I https://www.google.com
```

### **阶段二：系统环境准备 (20分钟)**

#### **步骤4: 系统兼容性检查**
```bash
# 4.1 给脚本执行权限
chmod +x ubuntu18-compatibility-check.sh

# 4.2 运行兼容性检查
./ubuntu18-compatibility-check.sh

# 4.3 查看检查结果
# 如果看到 "✅ 兼容性检查完成！" 说明系统兼容
```

#### **步骤5: 安装Docker环境（支持代理）**
```bash
# 5.1 运行增强的部署脚本
chmod +x deploy-ubuntu18.sh
./deploy-ubuntu18.sh

# 脚本会自动：
# - 检测代理配置
# - 配置APT代理
# - 配置Docker代理
# - 安装Docker和Docker Compose
# - 配置Docker镜像源

# 5.2 重新加载用户组权限
newgrp docker

# 5.3 验证Docker安装
docker --version
docker-compose --version

# 5.4 测试Docker权限
docker ps
```

### **阶段三：项目配置 (15分钟)**

#### **步骤6: 配置环境变量**
```bash
# 6.1 复制配置模板
cp .env.production .env

# 6.2 生成安全密钥
SECRET_KEY=$(openssl rand -hex 32)
JWT_SECRET_KEY=$(openssl rand -hex 32)

# 6.3 编辑配置文件
nano .env

# 在nano编辑器中修改以下内容：
```

**环境变量配置示例：**
```bash
# 数据库连接 (必须修改)
DATABASE_URL=postgresql://您的用户名:您的密码@您的高斯数据库地址:5432/您的数据库名

# 安全密钥 (必须修改)
SECRET_KEY=刚才生成的SECRET_KEY
JWT_SECRET_KEY=刚才生成的JWT_SECRET_KEY

# API配置 (如果有真实API)
CLASSIFICATION_API_URL=您的分类API地址
CLASSIFICATION_API_KEY=您的分类API密钥
AI_API_URL=您的AI生成API地址
AI_API_KEY=您的AI生成API密钥

# 代理配置 (如果API需要通过代理访问)
HTTP_PROXY=http://您的代理服务器地址:端口
HTTPS_PROXY=http://您的代理服务器地址:端口
```

#### **步骤7: 测试数据库连接**
```bash
# 7.1 测试高斯数据库连接
docker run --rm \
  --env http_proxy="$http_proxy" \
  --env https_proxy="$https_proxy" \
  postgres:13 \
  psql "postgresql://您的用户名:您的密码@您的高斯数据库地址:5432/您的数据库名" \
  -c "SELECT version();"

# 7.2 如果连接成功，应该显示数据库版本信息
```

### **阶段四：服务部署 (20分钟)**

#### **步骤8: 构建和启动服务**
```bash
# 8.1 启动部署（Docker会自动使用代理配置）
docker-compose -f docker-compose.ubuntu18.yml up -d --build

# 8.2 查看部署进度
docker-compose -f docker-compose.ubuntu18.yml logs -f

# 8.3 等待所有服务启动
# 看到类似信息说明启动成功：
# backend_1    | Starting QA Platform Backend...
# frontend_1   | Starting QA Platform Frontend...
# redis_1      | Ready to accept connections

# 8.4 按 Ctrl+C 退出日志查看
```

#### **步骤9: 验证部署成功**
```bash
# 9.1 检查容器状态
docker-compose -f docker-compose.ubuntu18.yml ps

# 应该看到所有容器状态为 "Up"

# 9.2 测试后端API
curl http://localhost:18088/api/health

# 应该返回：{"status": "healthy"}

# 9.3 测试前端服务
curl http://localhost:18080/health

# 应该返回：healthy

# 9.4 测试数据库连接
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    result = db.engine.execute('SELECT 1').scalar()
    print(f'✅ 数据库连接成功，测试查询结果: {result}')
"
```

#### **步骤10: 初始化数据库**
```bash
# 10.1 创建数据库表
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    db.create_all()
    print('✅ 数据库表创建完成')
"

# 10.2 验证表创建
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    tables = db.engine.table_names()
    print(f'✅ 创建的表: {tables}')
"
```

#### **步骤11: 访问系统**
```bash
# 11.1 获取服务器IP
hostname -I

# 11.2 在浏览器中访问
# 前端页面: http://您的服务器IP:18080
# 后端API: http://您的服务器IP:18088

# 11.3 登录系统
# 默认账号: admin
# 默认密码: admin123
```

## 🔧 **代理环境特殊配置**

### **Docker代理配置验证**
```bash
# 检查Docker daemon代理配置
sudo cat /etc/docker/daemon.json

# 检查Docker服务代理配置
sudo cat /etc/systemd/system/docker.service.d/http-proxy.conf

# 重启Docker服务（如果需要）
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### **容器内代理配置**
如果容器内的应用需要访问外部API，确保在docker-compose.ubuntu18.yml中添加代理环境变量：

```yaml
services:
  backend:
    environment:
      - HTTP_PROXY=${HTTP_PROXY}
      - HTTPS_PROXY=${HTTPS_PROXY}
      - NO_PROXY=localhost,127.0.0.1,::1
```

## 🚨 **常见问题解决**

### **问题1: 代理连接失败**
```bash
# 检查代理配置
echo $http_proxy
echo $https_proxy

# 测试代理连接
curl -v --proxy "$http_proxy" https://www.google.com

# 重新配置代理
./setup-proxy-environment.sh
```

### **问题2: Docker镜像下载失败**
```bash
# 检查Docker代理配置
sudo cat /etc/docker/daemon.json

# 手动拉取镜像测试
docker pull hello-world

# 如果失败，重新配置Docker代理
sudo systemctl restart docker
```

### **问题3: npm/yarn安装失败**
```bash
# 检查npm代理配置
npm config get proxy
npm config get https-proxy

# 重新配置npm代理
npm config set proxy "$http_proxy"
npm config set https-proxy "$https_proxy"
npm config set registry https://registry.npmmirror.com/
```

## ✅ **部署成功确认**

当您看到以下所有结果时，说明在代理环境下部署完全成功：

1. ✅ 代理连接测试通过
2. ✅ `docker-compose ps` 显示所有容器为"Up"状态
3. ✅ `curl http://localhost:18088/api/health` 返回健康状态
4. ✅ 浏览器可以访问 `http://您的服务器IP:18080`
5. ✅ 可以使用admin/admin123登录系统
6. ✅ 数据库连接测试通过

**恭喜！您的智能问答系统已在代理环境下成功部署！** 🎉
