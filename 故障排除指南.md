# 智能问答系统故障排除指南

## 🚨 **快速诊断命令**

当遇到问题时，请按顺序执行以下命令收集信息：

```bash
# 1. 检查系统基本信息
echo "=== 系统信息 ==="
uname -a
cat /etc/os-release

# 2. 检查Docker状态
echo "=== Docker状态 ==="
docker --version
docker-compose --version
systemctl status docker

# 3. 检查容器状态
echo "=== 容器状态 ==="
docker-compose -f docker-compose.ubuntu18.yml ps

# 4. 检查服务日志
echo "=== 服务日志 ==="
docker-compose -f docker-compose.ubuntu18.yml logs --tail=50

# 5. 检查端口占用
echo "=== 端口状态 ==="
netstat -tuln | grep -E ':(80|8088|6379|9090) '

# 6. 检查系统资源
echo "=== 系统资源 ==="
free -h
df -h
```

## 🔧 **常见问题解决方案**

### **问题1: Docker安装失败**

**症状**: `command not found: docker`

**解决方案**:
```bash
# 方案1: 使用官方脚本安装
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 方案2: 手动安装 (Ubuntu 18.04)
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker
sudo usermod -aG docker $USER
newgrp docker
```

### **问题2: Docker权限错误**

**症状**: `permission denied while trying to connect to the Docker daemon socket`

**解决方案**:
```bash
# 添加用户到docker组
sudo usermod -aG docker $USER

# 重新加载用户组
newgrp docker

# 或者重新登录
exit
# 重新SSH登录

# 验证权限
docker ps
```

### **问题3: 端口被占用**

**症状**: `port is already allocated` 或 `address already in use`

**解决方案**:
```bash
# 查看端口占用
sudo netstat -tulnp | grep :80
sudo netstat -tulnp | grep :8088

# 停止占用端口的服务
sudo systemctl stop nginx    # 如果nginx占用80端口
sudo systemctl stop apache2  # 如果apache占用80端口

# 或者修改端口映射
# 编辑 docker-compose.ubuntu18.yml
# 将 "80:80" 改为 "8080:80"
# 将 "8088:8088" 改为 "8089:8088"
```

### **问题4: 数据库连接失败**

**症状**: `could not connect to server` 或 `connection refused`

**解决方案**:
```bash
# 1. 检查数据库配置
cat .env | grep DATABASE_URL

# 2. 测试网络连通性
telnet 您的数据库地址 5432

# 3. 测试数据库连接
docker run --rm postgres:13 psql "您的数据库连接字符串" -c "SELECT version();"

# 4. 检查防火墙
sudo ufw status

# 5. 如果是内网数据库，检查VPN连接
ping 您的数据库地址
```

**常见数据库连接问题**:
```bash
# 错误的连接格式
❌ DATABASE_URL=postgresql://user:pass@host/db
✅ DATABASE_URL=postgresql://user:pass@host:5432/db

# 密码包含特殊字符需要编码
❌ DATABASE_URL=postgresql://user:p@ss@host:5432/db
✅ DATABASE_URL=postgresql://user:p%40ss@host:5432/db

# 主机名解析问题
❌ DATABASE_URL=postgresql://user:pass@db-server:5432/db
✅ DATABASE_URL=postgresql://user:pass@192.168.1.100:5432/db
```

### **问题5: 容器启动失败**

**症状**: 容器状态显示 `Exited` 或 `Restarting`

**解决方案**:
```bash
# 1. 查看容器详细日志
docker-compose -f docker-compose.ubuntu18.yml logs backend
docker-compose -f docker-compose.ubuntu18.yml logs frontend

# 2. 检查容器资源限制
docker stats

# 3. 重新构建镜像
docker-compose -f docker-compose.ubuntu18.yml down
docker-compose -f docker-compose.ubuntu18.yml build --no-cache
docker-compose -f docker-compose.ubuntu18.yml up -d

# 4. 单独启动容器进行调试
docker-compose -f docker-compose.ubuntu18.yml run --rm backend bash
```

### **问题6: 内存不足**

**症状**: `killed` 或 `out of memory`

**解决方案**:
```bash
# 1. 检查内存使用
free -h
docker stats

# 2. 增加swap空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 3. 优化容器内存限制
# 编辑 docker-compose.ubuntu18.yml
# 调整 mem_limit 参数

# 4. 清理Docker资源
docker system prune -a
```

### **问题7: 磁盘空间不足**

**症状**: `no space left on device`

**解决方案**:
```bash
# 1. 检查磁盘使用
df -h

# 2. 清理Docker资源
docker system prune -a --volumes

# 3. 清理系统日志
sudo journalctl --vacuum-time=7d

# 4. 清理APT缓存
sudo apt clean
sudo apt autoremove

# 5. 查找大文件
sudo find / -type f -size +100M 2>/dev/null | head -10
```

### **问题8: 网络连接问题**

**症状**: `network unreachable` 或 `timeout`

**解决方案**:
```bash
# 1. 检查网络配置
ip addr show
ip route show

# 2. 检查DNS解析
nslookup google.com
cat /etc/resolv.conf

# 3. 检查防火墙规则
sudo iptables -L
sudo ufw status verbose

# 4. 重启网络服务
sudo systemctl restart networking

# 5. 重启Docker网络
docker network prune
docker-compose -f docker-compose.ubuntu18.yml down
docker-compose -f docker-compose.ubuntu18.yml up -d
```

## 🔍 **高级调试技巧**

### **进入容器调试**
```bash
# 进入后端容器
docker-compose -f docker-compose.ubuntu18.yml exec backend bash

# 进入前端容器
docker-compose -f docker-compose.ubuntu18.yml exec frontend sh

# 查看容器内进程
docker-compose -f docker-compose.ubuntu18.yml exec backend ps aux

# 查看容器内网络
docker-compose -f docker-compose.ubuntu18.yml exec backend netstat -tuln
```

### **查看详细日志**
```bash
# 实时查看所有日志
docker-compose -f docker-compose.ubuntu18.yml logs -f

# 查看特定服务日志
docker-compose -f docker-compose.ubuntu18.yml logs -f backend

# 查看最近的日志
docker-compose -f docker-compose.ubuntu18.yml logs --tail=100 backend

# 查看带时间戳的日志
docker-compose -f docker-compose.ubuntu18.yml logs -f -t
```

### **性能监控**
```bash
# 监控容器资源使用
docker stats

# 监控系统资源
htop
iotop
nethogs

# 查看容器详细信息
docker inspect qa-platform-backend
```

## 📞 **获取技术支持**

如果以上方法都无法解决问题，请收集以下信息并联系技术支持：

### **必须提供的信息**
```bash
# 1. 系统信息
uname -a > debug-info.txt
cat /etc/os-release >> debug-info.txt

# 2. Docker信息
docker --version >> debug-info.txt
docker-compose --version >> debug-info.txt

# 3. 容器状态
docker-compose -f docker-compose.ubuntu18.yml ps >> debug-info.txt

# 4. 错误日志
docker-compose -f docker-compose.ubuntu18.yml logs >> debug-info.txt

# 5. 系统资源
free -h >> debug-info.txt
df -h >> debug-info.txt

# 6. 网络状态
netstat -tuln >> debug-info.txt

# 发送 debug-info.txt 文件
```

### **联系方式**
- **技术支持邮箱**: tech-support@company.com
- **紧急技术热线**: 400-xxx-xxxx
- **在线文档**: https://docs.qa-platform.com

### **问题描述模板**
```
问题描述: [详细描述遇到的问题]
错误信息: [完整的错误信息]
操作步骤: [导致问题的操作步骤]
系统环境: [Ubuntu版本、Docker版本等]
已尝试的解决方案: [已经尝试过的方法]
```

---

## ✅ **预防性维护建议**

### **定期检查**
```bash
# 每周执行一次
./verify-deployment.sh

# 每月执行一次
docker system prune
sudo apt update && sudo apt upgrade
```

### **监控指标**
- CPU使用率 < 80%
- 内存使用率 < 85%
- 磁盘使用率 < 90%
- 容器重启次数
- API响应时间

### **备份策略**
```bash
# 备份数据库
pg_dump -h 数据库地址 -U 用户名 -d 数据库名 > backup_$(date +%Y%m%d).sql

# 备份配置文件
tar -czf config_backup_$(date +%Y%m%d).tar.gz .env docker-compose.ubuntu18.yml

# 备份上传文件
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz uploads/
```
