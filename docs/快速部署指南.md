# 快速部署指南 - 生产环境

## 📋 部署概述

本指南提供AI问答平台在生产环境的快速部署步骤，适用于有经验的运维人员。

**详细部署手册**: 请参考 `docs/生产环境详细部署手册.md`

---

## 🚀 一键部署脚本

### 创建部署脚本

```bash
# 创建一键部署脚本
cat > deploy.sh << 'EOF'
#!/bin/bash
set -e

echo "🚀 开始部署AI问答平台..."

# 1. 环境检查
echo "📋 检查环境..."
python3 --version || { echo "Python3未安装"; exit 1; }
node --version || { echo "Node.js未安装"; exit 1; }
psql --version || { echo "PostgreSQL未安装"; exit 1; }
nginx -v || { echo "Nginx未安装"; exit 1; }

# 2. 创建用户
echo "👤 创建部署用户..."
sudo useradd -m -s /bin/bash aiqa 2>/dev/null || echo "用户已存在"
sudo usermod -aG sudo aiqa

# 3. 数据库配置
echo "🗄️ 配置数据库..."
sudo -u postgres psql -c "CREATE DATABASE aiqa_production;" 2>/dev/null || echo "数据库已存在"
sudo -u postgres psql -c "CREATE USER aiqa_user WITH PASSWORD 'AiQa2024#Prod';" 2>/dev/null || echo "用户已存在"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE aiqa_production TO aiqa_user;"

# 4. 克隆代码
echo "📦 克隆代码..."
sudo -u aiqa bash -c "
cd /home/aiqa
git clone https://github.com/duanxingchao/ai-qa-platform.git 2>/dev/null || (cd ai-qa-platform && git pull)
"

# 5. 后端部署
echo "🐍 部署后端..."
sudo -u aiqa bash -c "
cd /home/aiqa/ai-qa-platform
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r backend/requirements.txt

# 配置环境
cp backend/production.env backend/.env
sed -i 's/your_secure_password/AiQa2024#Prod/g' backend/.env

# 初始化数据库
source backend/.env
cd backend
python -c 'from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all(); print(\"数据库初始化完成\")'
"

# 6. 前端部署
echo "🎨 部署前端..."
sudo -u aiqa bash -c "
cd /home/aiqa/ai-qa-platform/frontend
npm install
SERVER_IP=\$(hostname -I | awk '{print \$1}')
cat > .env.production << EOL
VUE_APP_API_BASE_URL=http://\$SERVER_IP:8088/api
VUE_APP_TITLE=AI问答平台
NODE_ENV=production
EOL
npm run build
"

# 7. 配置Nginx
echo "🌐 配置Nginx..."
SERVER_IP=$(hostname -I | awk '{print $1}')
sudo tee /etc/nginx/sites-available/aiqa-platform << EOL
server {
    listen 80;
    server_name $SERVER_IP;
    
    location / {
        root /home/aiqa/ai-qa-platform/frontend/dist;
        try_files \$uri \$uri/ /index.html;
        index index.html;
    }
    
    location /api/ {
        proxy_pass http://127.0.0.1:8088/api/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOL

sudo ln -sf /etc/nginx/sites-available/aiqa-platform /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t && sudo systemctl restart nginx

# 8. 配置系统服务
echo "🔄 配置系统服务..."
sudo tee /etc/systemd/system/aiqa-backend.service << EOL
[Unit]
Description=AI QA Platform Backend
After=network.target postgresql.service

[Service]
Type=simple
User=aiqa
Group=aiqa
WorkingDirectory=/home/aiqa/ai-qa-platform/backend
Environment=PATH=/home/aiqa/ai-qa-platform/venv/bin
EnvironmentFile=/home/aiqa/ai-qa-platform/backend/.env
ExecStart=/home/aiqa/ai-qa-platform/venv/bin/python app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOL

sudo systemctl daemon-reload
sudo systemctl enable aiqa-backend
sudo systemctl start aiqa-backend

# 9. 验证部署
echo "✅ 验证部署..."
sleep 5
curl -f http://localhost:8088/api/health || { echo "后端服务启动失败"; exit 1; }
curl -f http://localhost/ || { echo "前端服务启动失败"; exit 1; }

echo "🎉 部署完成！"
echo "访问地址: http://$SERVER_IP"
echo "健康检查: http://$SERVER_IP/api/health"
EOF

chmod +x deploy.sh
```

---

## 🔧 手动部署步骤

### 1. 环境准备
```bash
# 安装基础软件
sudo apt update && sudo apt upgrade -y
sudo apt install python3 python3-pip python3-venv nodejs npm postgresql postgresql-contrib nginx git curl jq -y

# 创建用户
sudo useradd -m -s /bin/bash aiqa
sudo usermod -aG sudo aiqa
```

### 2. 数据库配置
```bash
# 启动PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 创建数据库
sudo -u postgres psql -c "CREATE DATABASE aiqa_production;"
sudo -u postgres psql -c "CREATE USER aiqa_user WITH PASSWORD 'AiQa2024#Prod';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE aiqa_production TO aiqa_user;"
```

### 3. 代码部署
```bash
# 切换到aiqa用户
sudo su - aiqa

# 克隆代码
git clone https://github.com/duanxingchao/ai-qa-platform.git
cd ai-qa-platform

# 后端部署
python3 -m venv venv
source venv/bin/activate
pip install -r backend/requirements.txt

# 配置环境
cp backend/production.env backend/.env
# 编辑 backend/.env 文件，修改数据库密码等配置

# 初始化数据库
source backend/.env
cd backend
python -c "from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all()"

# 前端部署
cd ../frontend
npm install
# 编辑 .env.production 文件，配置API地址
npm run build
```

### 4. 服务配置
```bash
# 配置Nginx（需要root权限）
exit  # 退出aiqa用户

# 创建Nginx配置
sudo nano /etc/nginx/sites-available/aiqa-platform
# 复制配置内容...

sudo ln -s /etc/nginx/sites-available/aiqa-platform /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t && sudo systemctl restart nginx

# 配置systemd服务
sudo nano /etc/systemd/system/aiqa-backend.service
# 复制服务配置...

sudo systemctl daemon-reload
sudo systemctl enable aiqa-backend
sudo systemctl start aiqa-backend
```

---

## ✅ 验证部署

### 快速验证脚本
```bash
# 创建验证脚本
cat > verify.sh << 'EOF'
#!/bin/bash

echo "🔍 验证部署状态..."

# 检查服务状态
echo "后端服务: $(systemctl is-active aiqa-backend)"
echo "Nginx服务: $(systemctl is-active nginx)"
echo "PostgreSQL服务: $(systemctl is-active postgresql)"

# 检查API
echo "后端API: $(curl -s http://localhost:8088/api/health | jq -r '.status' 2>/dev/null || echo '失败')"
echo "前端页面: $(curl -s -o /dev/null -w '%{http_code}' http://localhost/)"

# 检查荣耀API
echo "荣耀API测试:"
cd /home/aiqa/ai-qa-platform
sudo -u aiqa bash -c "source venv/bin/activate && python3 backend/test_honor_api_integration.py" | grep "所有测试通过" || echo "荣耀API测试失败"

SERVER_IP=$(hostname -I | awk '{print $1}')
echo "✅ 访问地址: http://$SERVER_IP"
EOF

chmod +x verify.sh
./verify.sh
```

---

## 🚨 故障排查

### 常见问题快速修复

#### 1. 后端服务启动失败
```bash
# 查看日志
sudo journalctl -u aiqa-backend -f

# 重启服务
sudo systemctl restart aiqa-backend

# 检查配置
sudo -u aiqa bash -c "cd /home/aiqa/ai-qa-platform && source venv/bin/activate && source backend/.env && python3 -c 'import os; print(os.getenv(\"DATABASE_URL\"))'"
```

#### 2. 前端页面无法访问
```bash
# 检查Nginx
sudo nginx -t
sudo systemctl restart nginx

# 检查文件权限
sudo chown -R aiqa:aiqa /home/aiqa/ai-qa-platform/
```

#### 3. 数据库连接失败
```bash
# 测试连接
psql -h localhost -U aiqa_user -d aiqa_production -c "SELECT 1;"

# 重启PostgreSQL
sudo systemctl restart postgresql
```

#### 4. 荣耀API连接失败
```bash
# 测试网络
ping aipipeline.ipd.hihonor.com

# 手动测试API
curl -X POST http://aipipeline.ipd.hihonor.com/v1/workflows/run \
  -H "Content-Type: application/json" \
  -d '{"inputs":{"QUERY":"测试"},"response_mode":"blocking","user":"00031559"}'
```

---

## 📊 监控和维护

### 日常维护命令
```bash
# 查看服务状态
sudo systemctl status aiqa-backend nginx postgresql

# 查看日志
sudo journalctl -u aiqa-backend --since "1 hour ago"

# 查看系统资源
htop
df -h
free -h

# 重启服务
sudo systemctl restart aiqa-backend
```

### 监控脚本
```bash
# 创建监控脚本
sudo -u aiqa bash -c "
cat > /home/aiqa/monitor.sh << 'EOF'
#!/bin/bash
echo \"=== \$(date) ===\"
echo \"服务状态: \$(systemctl is-active aiqa-backend)\"
echo \"API状态: \$(curl -s http://localhost:8088/api/health | jq -r '.status' 2>/dev/null || echo '失败')\"
echo \"磁盘使用: \$(df -h / | tail -1 | awk '{print \$5}')\"
echo \"内存使用: \$(free -h | grep Mem | awk '{print \$3\"/\"\$2}')\"
EOF
chmod +x /home/aiqa/monitor.sh
"

# 运行监控
sudo -u aiqa /home/aiqa/monitor.sh
```

---

## 🎯 部署检查清单

- [ ] 基础软件安装完成
- [ ] 数据库配置完成
- [ ] 代码克隆和配置完成
- [ ] 后端服务运行正常
- [ ] 前端构建和部署完成
- [ ] Nginx配置正确
- [ ] 系统服务配置完成
- [ ] 荣耀API连接测试通过
- [ ] 前端页面可以访问
- [ ] 所有功能验证通过

---

## 🎉 部署完成

**部署成功！** 您的AI问答平台现在已在生产环境中运行。

**访问地址**: `http://服务器IP`

**管理命令**:
- 查看状态: `sudo systemctl status aiqa-backend`
- 重启服务: `sudo systemctl restart aiqa-backend`
- 查看日志: `sudo journalctl -u aiqa-backend -f`
- 运行监控: `sudo -u aiqa /home/aiqa/monitor.sh`

如需详细的部署说明和故障排查，请参考 `docs/生产环境详细部署手册.md`。
