# å¿«é€Ÿéƒ¨ç½²æŒ‡å— - ç”Ÿäº§ç¯å¢ƒ

## ğŸ“‹ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—æä¾›AIé—®ç­”å¹³å°åœ¨ç”Ÿäº§ç¯å¢ƒçš„å¿«é€Ÿéƒ¨ç½²æ­¥éª¤ï¼Œé€‚ç”¨äºæœ‰ç»éªŒçš„è¿ç»´äººå‘˜ã€‚

**è¯¦ç»†éƒ¨ç½²æ‰‹å†Œ**: è¯·å‚è€ƒ `docs/ç”Ÿäº§ç¯å¢ƒè¯¦ç»†éƒ¨ç½²æ‰‹å†Œ.md`

---

## ğŸš€ ä¸€é”®éƒ¨ç½²è„šæœ¬

### åˆ›å»ºéƒ¨ç½²è„šæœ¬

```bash
# åˆ›å»ºä¸€é”®éƒ¨ç½²è„šæœ¬
cat > deploy.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²AIé—®ç­”å¹³å°..."

# 1. ç¯å¢ƒæ£€æŸ¥
echo "ğŸ“‹ æ£€æŸ¥ç¯å¢ƒ..."
python3 --version || { echo "Python3æœªå®‰è£…"; exit 1; }
node --version || { echo "Node.jsæœªå®‰è£…"; exit 1; }
psql --version || { echo "PostgreSQLæœªå®‰è£…"; exit 1; }
nginx -v || { echo "Nginxæœªå®‰è£…"; exit 1; }

# 2. åˆ›å»ºç”¨æˆ·
echo "ğŸ‘¤ åˆ›å»ºéƒ¨ç½²ç”¨æˆ·..."
sudo useradd -m -s /bin/bash aiqa 2>/dev/null || echo "ç”¨æˆ·å·²å­˜åœ¨"
sudo usermod -aG sudo aiqa

# 3. æ•°æ®åº“é…ç½®
echo "ğŸ—„ï¸ é…ç½®æ•°æ®åº“..."
sudo -u postgres psql -c "CREATE DATABASE aiqa_production;" 2>/dev/null || echo "æ•°æ®åº“å·²å­˜åœ¨"
sudo -u postgres psql -c "CREATE USER aiqa_user WITH PASSWORD 'AiQa2024#Prod';" 2>/dev/null || echo "ç”¨æˆ·å·²å­˜åœ¨"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE aiqa_production TO aiqa_user;"

# 4. å…‹éš†ä»£ç 
echo "ğŸ“¦ å…‹éš†ä»£ç ..."
sudo -u aiqa bash -c "
cd /home/aiqa
git clone https://github.com/duanxingchao/ai-qa-platform.git 2>/dev/null || (cd ai-qa-platform && git pull)
"

# 5. åç«¯éƒ¨ç½²
echo "ğŸ éƒ¨ç½²åç«¯..."
sudo -u aiqa bash -c "
cd /home/aiqa/ai-qa-platform
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r backend/requirements.txt

# é…ç½®ç¯å¢ƒ
cp backend/production.env backend/.env
sed -i 's/your_secure_password/AiQa2024#Prod/g' backend/.env

# åˆå§‹åŒ–æ•°æ®åº“
source backend/.env
cd backend
python -c 'from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all(); print(\"æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ\")'
"

# 6. å‰ç«¯éƒ¨ç½²
echo "ğŸ¨ éƒ¨ç½²å‰ç«¯..."
sudo -u aiqa bash -c "
cd /home/aiqa/ai-qa-platform/frontend
npm install
SERVER_IP=\$(hostname -I | awk '{print \$1}')
cat > .env.production << EOL
VUE_APP_API_BASE_URL=http://\$SERVER_IP:8088/api
VUE_APP_TITLE=AIé—®ç­”å¹³å°
NODE_ENV=production
EOL
npm run build
"

# 7. é…ç½®Nginx
echo "ğŸŒ é…ç½®Nginx..."
SERVER_IP=$(hostname -I | awk '{print $1}')
sudo tee /etc/nginx/sites-available/aiqa-platform << EOL
server {
    listen 80;
    server_name $SERVER_IP;
    
    location / {
        root /home/aiqa/ai-qa-platform/frontend/dist;
        try_files \$uri \$uri/ /index.html;
        index index.html;
    }
    
    location /api/ {
        proxy_pass http://127.0.0.1:8088/api/;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOL

sudo ln -sf /etc/nginx/sites-available/aiqa-platform /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t && sudo systemctl restart nginx

# 8. é…ç½®ç³»ç»ŸæœåŠ¡
echo "ğŸ”„ é…ç½®ç³»ç»ŸæœåŠ¡..."
sudo tee /etc/systemd/system/aiqa-backend.service << EOL
[Unit]
Description=AI QA Platform Backend
After=network.target postgresql.service

[Service]
Type=simple
User=aiqa
Group=aiqa
WorkingDirectory=/home/aiqa/ai-qa-platform/backend
Environment=PATH=/home/aiqa/ai-qa-platform/venv/bin
EnvironmentFile=/home/aiqa/ai-qa-platform/backend/.env
ExecStart=/home/aiqa/ai-qa-platform/venv/bin/python app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOL

sudo systemctl daemon-reload
sudo systemctl enable aiqa-backend
sudo systemctl start aiqa-backend

# 9. éªŒè¯éƒ¨ç½²
echo "âœ… éªŒè¯éƒ¨ç½²..."
sleep 5
curl -f http://localhost:8088/api/health || { echo "åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"; exit 1; }
curl -f http://localhost/ || { echo "å‰ç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"; exit 1; }

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
echo "è®¿é—®åœ°å€: http://$SERVER_IP"
echo "å¥åº·æ£€æŸ¥: http://$SERVER_IP/api/health"
EOF

chmod +x deploy.sh
```

---

## ğŸ”§ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…åŸºç¡€è½¯ä»¶
sudo apt update && sudo apt upgrade -y
sudo apt install python3 python3-pip python3-venv nodejs npm postgresql postgresql-contrib nginx git curl jq -y

# åˆ›å»ºç”¨æˆ·
sudo useradd -m -s /bin/bash aiqa
sudo usermod -aG sudo aiqa
```

### 2. æ•°æ®åº“é…ç½®
```bash
# å¯åŠ¨PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql

# åˆ›å»ºæ•°æ®åº“
sudo -u postgres psql -c "CREATE DATABASE aiqa_production;"
sudo -u postgres psql -c "CREATE USER aiqa_user WITH PASSWORD 'AiQa2024#Prod';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE aiqa_production TO aiqa_user;"
```

### 3. ä»£ç éƒ¨ç½²
```bash
# åˆ‡æ¢åˆ°aiqaç”¨æˆ·
sudo su - aiqa

# å…‹éš†ä»£ç 
git clone https://github.com/duanxingchao/ai-qa-platform.git
cd ai-qa-platform

# åç«¯éƒ¨ç½²
python3 -m venv venv
source venv/bin/activate
pip install -r backend/requirements.txt

# é…ç½®ç¯å¢ƒ
cp backend/production.env backend/.env
# ç¼–è¾‘ backend/.env æ–‡ä»¶ï¼Œä¿®æ”¹æ•°æ®åº“å¯†ç ç­‰é…ç½®

# åˆå§‹åŒ–æ•°æ®åº“
source backend/.env
cd backend
python -c "from app import create_app, db; app = create_app(); app.app_context().push(); db.create_all()"

# å‰ç«¯éƒ¨ç½²
cd ../frontend
npm install
# ç¼–è¾‘ .env.production æ–‡ä»¶ï¼Œé…ç½®APIåœ°å€
npm run build
```

### 4. æœåŠ¡é…ç½®
```bash
# é…ç½®Nginxï¼ˆéœ€è¦rootæƒé™ï¼‰
exit  # é€€å‡ºaiqaç”¨æˆ·

# åˆ›å»ºNginxé…ç½®
sudo nano /etc/nginx/sites-available/aiqa-platform
# å¤åˆ¶é…ç½®å†…å®¹...

sudo ln -s /etc/nginx/sites-available/aiqa-platform /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t && sudo systemctl restart nginx

# é…ç½®systemdæœåŠ¡
sudo nano /etc/systemd/system/aiqa-backend.service
# å¤åˆ¶æœåŠ¡é…ç½®...

sudo systemctl daemon-reload
sudo systemctl enable aiqa-backend
sudo systemctl start aiqa-backend
```

---

## âœ… éªŒè¯éƒ¨ç½²

### å¿«é€ŸéªŒè¯è„šæœ¬
```bash
# åˆ›å»ºéªŒè¯è„šæœ¬
cat > verify.sh << 'EOF'
#!/bin/bash

echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
echo "åç«¯æœåŠ¡: $(systemctl is-active aiqa-backend)"
echo "NginxæœåŠ¡: $(systemctl is-active nginx)"
echo "PostgreSQLæœåŠ¡: $(systemctl is-active postgresql)"

# æ£€æŸ¥API
echo "åç«¯API: $(curl -s http://localhost:8088/api/health | jq -r '.status' 2>/dev/null || echo 'å¤±è´¥')"
echo "å‰ç«¯é¡µé¢: $(curl -s -o /dev/null -w '%{http_code}' http://localhost/)"

# æ£€æŸ¥è£è€€API
echo "è£è€€APIæµ‹è¯•:"
cd /home/aiqa/ai-qa-platform
sudo -u aiqa bash -c "source venv/bin/activate && python3 backend/test_honor_api_integration.py" | grep "æ‰€æœ‰æµ‹è¯•é€šè¿‡" || echo "è£è€€APIæµ‹è¯•å¤±è´¥"

SERVER_IP=$(hostname -I | awk '{print $1}')
echo "âœ… è®¿é—®åœ°å€: http://$SERVER_IP"
EOF

chmod +x verify.sh
./verify.sh
```

---

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜å¿«é€Ÿä¿®å¤

#### 1. åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u aiqa-backend -f

# é‡å¯æœåŠ¡
sudo systemctl restart aiqa-backend

# æ£€æŸ¥é…ç½®
sudo -u aiqa bash -c "cd /home/aiqa/ai-qa-platform && source venv/bin/activate && source backend/.env && python3 -c 'import os; print(os.getenv(\"DATABASE_URL\"))'"
```

#### 2. å‰ç«¯é¡µé¢æ— æ³•è®¿é—®
```bash
# æ£€æŸ¥Nginx
sudo nginx -t
sudo systemctl restart nginx

# æ£€æŸ¥æ–‡ä»¶æƒé™
sudo chown -R aiqa:aiqa /home/aiqa/ai-qa-platform/
```

#### 3. æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æµ‹è¯•è¿æ¥
psql -h localhost -U aiqa_user -d aiqa_production -c "SELECT 1;"

# é‡å¯PostgreSQL
sudo systemctl restart postgresql
```

#### 4. è£è€€APIè¿æ¥å¤±è´¥
```bash
# æµ‹è¯•ç½‘ç»œ
ping aipipeline.ipd.hihonor.com

# æ‰‹åŠ¨æµ‹è¯•API
curl -X POST http://aipipeline.ipd.hihonor.com/v1/workflows/run \
  -H "Content-Type: application/json" \
  -d '{"inputs":{"QUERY":"æµ‹è¯•"},"response_mode":"blocking","user":"00031559"}'
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æ—¥å¸¸ç»´æŠ¤å‘½ä»¤
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status aiqa-backend nginx postgresql

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u aiqa-backend --since "1 hour ago"

# æŸ¥çœ‹ç³»ç»Ÿèµ„æº
htop
df -h
free -h

# é‡å¯æœåŠ¡
sudo systemctl restart aiqa-backend
```

### ç›‘æ§è„šæœ¬
```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
sudo -u aiqa bash -c "
cat > /home/aiqa/monitor.sh << 'EOF'
#!/bin/bash
echo \"=== \$(date) ===\"
echo \"æœåŠ¡çŠ¶æ€: \$(systemctl is-active aiqa-backend)\"
echo \"APIçŠ¶æ€: \$(curl -s http://localhost:8088/api/health | jq -r '.status' 2>/dev/null || echo 'å¤±è´¥')\"
echo \"ç£ç›˜ä½¿ç”¨: \$(df -h / | tail -1 | awk '{print \$5}')\"
echo \"å†…å­˜ä½¿ç”¨: \$(free -h | grep Mem | awk '{print \$3\"/\"\$2}')\"
EOF
chmod +x /home/aiqa/monitor.sh
"

# è¿è¡Œç›‘æ§
sudo -u aiqa /home/aiqa/monitor.sh
```

---

## ğŸ¯ éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] åŸºç¡€è½¯ä»¶å®‰è£…å®Œæˆ
- [ ] æ•°æ®åº“é…ç½®å®Œæˆ
- [ ] ä»£ç å…‹éš†å’Œé…ç½®å®Œæˆ
- [ ] åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] å‰ç«¯æ„å»ºå’Œéƒ¨ç½²å®Œæˆ
- [ ] Nginxé…ç½®æ­£ç¡®
- [ ] ç³»ç»ŸæœåŠ¡é…ç½®å®Œæˆ
- [ ] è£è€€APIè¿æ¥æµ‹è¯•é€šè¿‡
- [ ] å‰ç«¯é¡µé¢å¯ä»¥è®¿é—®
- [ ] æ‰€æœ‰åŠŸèƒ½éªŒè¯é€šè¿‡

---

## ğŸ‰ éƒ¨ç½²å®Œæˆ

**éƒ¨ç½²æˆåŠŸï¼** æ‚¨çš„AIé—®ç­”å¹³å°ç°åœ¨å·²åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œã€‚

**è®¿é—®åœ°å€**: `http://æœåŠ¡å™¨IP`

**ç®¡ç†å‘½ä»¤**:
- æŸ¥çœ‹çŠ¶æ€: `sudo systemctl status aiqa-backend`
- é‡å¯æœåŠ¡: `sudo systemctl restart aiqa-backend`
- æŸ¥çœ‹æ—¥å¿—: `sudo journalctl -u aiqa-backend -f`
- è¿è¡Œç›‘æ§: `sudo -u aiqa /home/aiqa/monitor.sh`

å¦‚éœ€è¯¦ç»†çš„éƒ¨ç½²è¯´æ˜å’Œæ•…éšœæ’æŸ¥ï¼Œè¯·å‚è€ƒ `docs/ç”Ÿäº§ç¯å¢ƒè¯¦ç»†éƒ¨ç½²æ‰‹å†Œ.md`ã€‚
