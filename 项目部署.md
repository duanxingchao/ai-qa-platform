# AI问答平台项目部署指南

## 📋 部署概述

本指南适用于在公司内网Ubuntu服务器上部署AI问答平台，集成荣耀内部API和高斯数据库。

### 🎯 部署目标
- 部署完整的AI问答平台（前端+后端）
- 集成荣耀分类API和评分API
- 连接高斯数据库（dm_rnd_xa_export schema）
- 配置内网代理环境
- 使用Docker容器化部署

---

## ✅ 已完成的代码配置

### **API配置**
- **分类API地址**: `http://aipipeline.ipd.hihonor.com/v1/workflows/run`
- **分类API密钥**: `app-mw]Eht3zDaKUЗLAa6T9XKwu`
- **评分API地址**: `http://aipipeline.ipd.hihonor.com/v1/workflows/run`
- **评分API密钥**: `app-SXgaGHIf25NtJXEFmc9ecRSc`

### **数据库配置**
- **数据库类型**: 高斯数据库
- **数据库用户**: `dmp_rnd_xa`
- **数据库端口**: `8000`
- **数据库名**: `datalake`
- **Schema**: `dm_rnd_xa_export`
- **源表**: `mid_pc_yoyo_qa_641000052`

### **Git提交状态**
- **最新提交**: `96e0ba0 feat: 更新荣耀API完整配置`
- **状态**: 所有配置已更新并推送到远程仓库

---

## 📋 部署前准备清单

### **需要您准备的信息**
| 项目 | 示例 | 说明 |
|------|------|------|
| 代理服务器地址 | `http://proxy.company.com:8080` | 用于访问外网下载依赖 |
| 数据库主机地址 | `db.company.com` 或 `192.168.1.100` | 高斯数据库服务器地址 |
| 数据库密码 | `您的dmp_rnd_xa密码` | 数据库用户密码 |

### **环境要求**
- **操作系统**: Ubuntu 18.04+
- **权限**: sudo权限
- **端口**: 18080（前端）、8088（后端）可用
- **网络**: 能访问代理服务器和内网数据库

---

## 🚀 详细部署步骤

### **步骤1: 创建专用用户（安全最佳实践）**
```bash
# 1.1 创建应用专用用户
sudo useradd -m -s /bin/bash qaplatform

# 1.2 添加用户到docker组
sudo usermod -aG docker qaplatform

# 1.3 配置必要的sudo权限
echo "qaplatform ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/bin/docker-compose, /usr/bin/systemctl" | sudo tee /etc/sudoers.d/qaplatform

# 1.4 切换到专用用户
sudo su - qaplatform

# 1.5 验证用户环境
whoami
pwd  # 应该在 /home/qaplatform
```

### **步骤2: 获取项目代码**
```bash
# 2.1 克隆项目代码
git clone https://github.com/duanxingchao/ai-qa-platform.git

# 2.2 进入项目目录
cd ai-qa-platform

# 2.3 确认版本
git log --oneline -3
# 应该看到: 96e0ba0 feat: 更新荣耀API完整配置

# 2.4 检查部署脚本
ls -la quick-deploy-with-proxy.sh
```

### **步骤3: 配置部署参数**
```bash
# 3.1 查看配置文件（已预配置荣耀环境）
cat deploy-config.sh

# 配置文件内容：
# HTTP_PROXY="http://proxyssx.his.hihonor.com:8080"
# HTTPS_PROXY="http://proxyssx.his.hihonor.com:8080"
# FTP_PROXY="http://proxyssx.his.hihonor.com:8080"
# NO_PROXY="localhost,127.0.0.1,w3.hihonor.com,mgf-tm.ipd.hihonor.com,mirrors.chinatelecom.hihonor.io"
# DB_HOST="dws-digital-datalake.digital.hihonor.com"
# DB_PORT="8000"
# DB_USER="dmp_rnd_xa"
# DB_NAME="需要在运行时输入"
# DB_PASSWORD="需要在运行时输入"
# USE_GLORY_API="y"
```

### **步骤4: 一键自动部署**
```bash
# 4.1 给脚本执行权限
chmod +x quick-deploy-with-proxy.sh

# 4.2 运行自动部署脚本（仅需输入数据库名和密码）
./quick-deploy-with-proxy.sh

# 脚本运行时会提示：
# 请输入数据库名称: [输入您的数据库名]
# 请输入数据库密码: [输入密码，不会显示]
```

### **步骤5: 自动化执行过程**
脚本会自动执行以下操作：
```
1. ✅ 检查系统环境 (Ubuntu版本、权限等)
2. ✅ 配置系统代理环境变量
3. ✅ 安装Docker和Docker Compose
4. ✅ 配置Docker代理设置
5. ✅ 生成数据库连接配置
6. ✅ 生成荣耀API配置文件
7. ✅ 构建和启动Docker服务
8. ✅ 验证服务状态
9. ✅ 测试数据库连接
10. ✅ 测试荣耀分类API连接
11. ✅ 测试荣耀评分API连接
```

### **步骤6: 部署完成验证**
部署成功后会显示：
```
🎉 部署完成！

📊 服务状态:
✅ 后端服务: 运行中
✅ 前端服务: 运行中  
✅ 数据库连接: 正常
✅ 荣耀分类API连接: 正常 (app-mw]Eht3zDaKUЗLAa6T9XKwu)
✅ 荣耀评分API连接: 正常 (app-SXgaGHIf25NtJXEFmc9ecRSc)

🌐 访问地址:
前端: http://服务器IP:18080
后端API: http://服务器IP:8088/api
健康检查: http://服务器IP:8088/api/health

🔧 管理命令:
查看状态: docker-compose -f docker-compose.ubuntu18.yml ps
查看日志: docker-compose -f docker-compose.ubuntu18.yml logs -f
重启服务: docker-compose -f docker-compose.ubuntu18.yml restart
```

---

## 🔧 常用管理命令

### **服务管理**
```bash
# 查看服务状态
docker-compose -f docker-compose.ubuntu18.yml ps

# 查看服务日志
docker-compose -f docker-compose.ubuntu18.yml logs -f

# 重启服务
docker-compose -f docker-compose.ubuntu18.yml restart

# 停止服务
docker-compose -f docker-compose.ubuntu18.yml down

# 启动服务
docker-compose -f docker-compose.ubuntu18.yml up -d
```

### **健康检查**
```bash
# 检查后端API
curl http://localhost:8088/api/health

# 检查前端页面
curl -I http://localhost:18080

# 测试荣耀API连接
docker-compose -f docker-compose.ubuntu18.yml exec backend python test_honor_api_integration.py
```

### **数据库操作**
```bash
# 进入后端容器
docker-compose -f docker-compose.ubuntu18.yml exec backend bash

# 在容器内连接数据库
python -c "
from app import create_app, db
app = create_app()
with app.app_context():
    # 测试数据库连接
    result = db.engine.execute('SELECT 1')
    print('数据库连接正常')
"
```

---

## 🚨 故障排查

### **常见问题及解决方案**

#### **1. Git克隆失败**
```bash
# 问题: 文件夹为空或克隆失败
# 解决方案:
# 1) 检查代理配置
echo $http_proxy
echo $https_proxy

# 2) 重新配置Git代理
git config --global http.proxy http://您的代理地址:端口
git config --global https.proxy http://您的代理地址:端口

# 3) 测试网络连接
ping github.com
curl -I https://github.com

# 4) 备用方案：手动下载
wget https://github.com/duanxingchao/ai-qa-platform/archive/refs/heads/master.zip
unzip master.zip
mv ai-qa-platform-master ai-qa-platform
```

#### **2. Docker服务启动失败**
```bash
# 查看详细错误
docker-compose -f docker-compose.ubuntu18.yml logs

# 检查端口占用
netstat -tlnp | grep -E "(18080|8088)"

# 重新构建镜像
docker-compose -f docker-compose.ubuntu18.yml build --no-cache
```

#### **3. 数据库连接失败**
```bash
# 检查数据库配置
cat .env | grep DATABASE

# 测试数据库连接
telnet 数据库主机 8000

# 检查Schema权限
# 确保dmp_rnd_xa用户对dm_rnd_xa_export schema有完整权限
```

#### **4. 荣耀API连接失败**
```bash
# 测试API连通性
curl -X POST http://aipipeline.ipd.hihonor.com/v1/workflows/run \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer app-mw]Eht3zDaKUЗLAa6T9XKwu" \
  -d '{"inputs":{"QUERY":"测试"},"response_mode":"blocking","user":"00031559"}'

# 检查API配置
cat .env | grep -E "(CLASSIFY_API|SCORE_API)"
```

---

## 📞 技术支持

### **日常维护**
- **监控服务状态**: 定期检查Docker容器运行状态
- **查看日志**: 监控应用日志，及时发现问题
- **数据备份**: 定期备份数据库数据
- **性能监控**: 监控CPU、内存、磁盘使用情况

### **联系方式**
如遇到技术问题，请提供以下信息：
1. 错误日志内容
2. 系统环境信息
3. 部署步骤执行情况
4. 网络和代理配置

---

## 🎯 部署总结

**预计部署时间**: 15-30分钟
**服务端口**: 前端18080，后端8088
**访问方式**: 浏览器访问 `http://服务器IP:18080`

**关键成功因素**:
1. ✅ 正确配置代理环境
2. ✅ 准确输入数据库连接信息
3. ✅ 确保端口未被占用
4. ✅ 网络连通性正常

部署完成后，您将拥有一个完整的AI问答平台，支持问题分类、答案生成和智能评分功能！🎉
