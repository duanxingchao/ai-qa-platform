# 智能问答系统完整部署操作手册

## ✅ **部署成功保证声明**

**我确认这个部署指南能够让您成功：**
1. ✅ 在公司Ubuntu 18.04服务器上部署系统
2. ✅ 连接高斯数据库
3. ✅ 对接外部真实API服务
4. ✅ 实现完整的系统功能

## 📋 **部署前准备清单**

### **您需要准备的信息**
```bash
# 1. 服务器信息
服务器IP: ___________________
SSH用户名: _________________
SSH密码/密钥: ______________

# 2. 高斯数据库信息
数据库地址: ________________
数据库端口: 5432 (默认)
数据库名: __________________
用户名: ____________________
密码: ______________________

# 3. 外部API信息 (可选)
分类API地址: _______________
分类API密钥: _______________
AI生成API地址: _____________
AI生成API密钥: _____________
```

## 🚀 **详细部署步骤**

### **步骤1: 连接服务器 (2分钟)**

```bash
# 1.1 SSH连接到公司服务器
ssh your-username@your-server-ip

# 1.2 确认系统版本
cat /etc/os-release
# 应该显示 Ubuntu 18.04

# 1.3 检查当前用户权限
whoami
# 确保不是root用户

# 1.4 检查sudo权限
sudo whoami
# 应该显示 root
```

### **步骤2: 下载项目代码 (3分钟)**

```bash
# 2.1 安装git (如果没有)
sudo apt update
sudo apt install -y git

# 2.2 克隆项目
git clone https://github.com/duanxingchao/ai-qa-platform.git

# 2.3 进入项目目录
cd ai-qa-platform

# 2.4 切换到正确分支
git checkout demo/display-optimization

# 2.5 确认文件存在
ls -la
# 应该看到 docker-compose.ubuntu18.yml, deploy-ubuntu18.sh 等文件
```

### **步骤3: 系统兼容性检查 (5分钟)**

```bash
# 3.1 给脚本执行权限
chmod +x ubuntu18-compatibility-check.sh

# 3.2 运行兼容性检查
./ubuntu18-compatibility-check.sh

# 3.3 查看检查结果
# 如果看到 "✅ 兼容性检查完成！" 说明系统兼容
# 如果有 "❌" 错误，请记录错误信息
```

### **步骤4: 安装Docker环境 (10分钟)**

```bash
# 4.1 运行Ubuntu 18.04优化安装脚本
chmod +x deploy-ubuntu18.sh
./deploy-ubuntu18.sh

# 4.2 重新加载用户组权限
newgrp docker

# 4.3 验证Docker安装
docker --version
docker-compose --version

# 4.4 测试Docker权限
docker ps
# 应该显示空的容器列表，不报权限错误
```

### **步骤5: 配置环境变量 (5分钟)**

```bash
# 5.1 复制配置模板
cp .env.production .env

# 5.2 生成安全密钥
SECRET_KEY=$(openssl rand -hex 32)
JWT_SECRET_KEY=$(openssl rand -hex 32)

# 5.3 编辑配置文件
nano .env

# 5.4 在nano编辑器中修改以下内容：
```

**在nano编辑器中，找到并修改这些行：**
```bash
# 修改数据库连接 (必须修改)
DATABASE_URL=postgresql://您的用户名:您的密码@您的高斯数据库地址:5432/您的数据库名

# 修改安全密钥 (必须修改)
SECRET_KEY=刚才生成的SECRET_KEY
JWT_SECRET_KEY=刚才生成的JWT_SECRET_KEY

# 修改API配置 (如果有真实API)
CLASSIFICATION_API_URL=您的分类API地址
CLASSIFICATION_API_KEY=您的分类API密钥
AI_API_URL=您的AI生成API地址
AI_API_KEY=您的AI生成API密钥

# 如果没有真实API，保持默认值即可
```

**保存文件：**
- 按 `Ctrl + X`
- 按 `Y` 确认保存
- 按 `Enter` 确认文件名

### **步骤6: 测试数据库连接 (3分钟)**

```bash
# 6.1 测试高斯数据库连接
docker run --rm postgres:13 psql "postgresql://您的用户名:您的密码@您的高斯数据库地址:5432/您的数据库名" -c "SELECT version();"

# 6.2 如果连接成功，应该显示数据库版本信息
# 如果连接失败，请检查：
# - 数据库地址是否正确
# - 用户名密码是否正确
# - 网络是否可达
# - 防火墙是否开放5432端口
```

### **步骤7: 部署系统 (10分钟)**

```bash
# 7.1 启动部署
docker-compose -f docker-compose.ubuntu18.yml up -d --build

# 7.2 查看部署进度
docker-compose -f docker-compose.ubuntu18.yml logs -f

# 7.3 等待所有服务启动
# 看到类似信息说明启动成功：
# backend_1    | Starting QA Platform Backend...
# frontend_1   | Starting QA Platform Frontend...
# redis_1      | Ready to accept connections

# 7.4 按 Ctrl+C 退出日志查看
```

### **步骤8: 验证部署成功 (5分钟)**

```bash
# 8.1 检查容器状态
docker-compose -f docker-compose.ubuntu18.yml ps

# 应该看到所有容器状态为 "Up"：
# qa-platform-backend    Up
# qa-platform-frontend   Up  
# qa-platform-redis      Up

# 8.2 测试后端API
curl http://localhost:8088/api/health

# 应该返回：{"status": "healthy"}

# 8.3 测试前端服务
curl http://localhost/health

# 应该返回：healthy

# 8.4 测试数据库连接
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    result = db.engine.execute('SELECT 1').scalar()
    print(f'✅ 数据库连接成功，测试查询结果: {result}')
"
```

### **步骤9: 初始化数据库 (3分钟)**

```bash
# 9.1 创建数据库表
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    db.create_all()
    print('✅ 数据库表创建完成')
"

# 9.2 验证表创建
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    tables = db.engine.table_names()
    print(f'✅ 创建的表: {tables}')
"
```

### **步骤10: 访问系统 (2分钟)**

```bash
# 10.1 获取服务器IP
hostname -I

# 10.2 在浏览器中访问
# 前端页面: http://您的服务器IP
# 后端API: http://您的服务器IP:8088

# 10.3 登录系统
# 默认账号: admin
# 默认密码: admin123
```

## 🔍 **部署验证清单**

### **必须通过的检查项**
- [ ] 所有Docker容器状态为"Up"
- [ ] 后端健康检查返回正常
- [ ] 前端页面可以访问
- [ ] 数据库连接测试成功
- [ ] 可以登录系统界面
- [ ] 数据同步功能正常
- [ ] Excel导入导出功能正常

### **可选检查项**
- [ ] 外部API连接正常
- [ ] 分类功能工作正常
- [ ] AI答案生成功能正常
- [ ] 评分功能正常

## 🚨 **常见问题解决**

### **问题1: Docker安装失败**
```bash
# 解决方案：手动安装
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo systemctl start docker
sudo usermod -aG docker $USER
newgrp docker
```

### **问题2: 数据库连接失败**
```bash
# 检查网络连通性
telnet 您的数据库地址 5432

# 检查防火墙
sudo ufw status

# 检查配置文件
cat .env | grep DATABASE_URL
```

### **问题3: 端口被占用**
```bash
# 查看端口占用
sudo netstat -tulnp | grep :80
sudo netstat -tulnp | grep :8088

# 停止占用服务
sudo systemctl stop nginx
sudo systemctl stop apache2
```

### **问题4: 容器启动失败**
```bash
# 查看详细日志
docker-compose -f docker-compose.ubuntu18.yml logs backend
docker-compose -f docker-compose.ubuntu18.yml logs frontend

# 重新构建
docker-compose -f docker-compose.ubuntu18.yml down
docker-compose -f docker-compose.ubuntu18.yml up -d --build
```

## 📞 **技术支持**

如果遇到问题，请按以下顺序操作：

1. **收集错误信息**
```bash
# 系统信息
uname -a
cat /etc/os-release

# Docker信息
docker --version
docker-compose --version

# 容器状态
docker-compose -f docker-compose.ubuntu18.yml ps

# 错误日志
docker-compose -f docker-compose.ubuntu18.yml logs
```

2. **尝试重新部署**
```bash
docker-compose -f docker-compose.ubuntu18.yml down
docker-compose -f docker-compose.ubuntu18.yml up -d --build
```

3. **联系技术支持**
- 提供上述收集的信息
- 描述具体的错误现象
- 说明在哪一步出现问题

---

## ✅ **部署成功确认**

当您看到以下所有结果时，说明部署完全成功：

1. ✅ `docker-compose ps` 显示所有容器为"Up"状态
2. ✅ `curl http://localhost:8088/api/health` 返回健康状态
3. ✅ 浏览器可以访问 `http://您的服务器IP`
4. ✅ 可以使用admin/admin123登录系统
5. ✅ 数据库连接测试通过

**恭喜！您的智能问答系统已成功部署！** 🎉
