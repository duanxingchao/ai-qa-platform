# 🚀 智能问答系统完整部署操作手册 (最新版)

## 📋 **部署前准备信息清单**

### **系统要求**
- 操作系统：Ubuntu 18.04 LTS
- 内存：至少 4GB RAM
- 磁盘空间：至少 20GB 可用空间
- 网络：可通过代理访问外网

### **必需信息清单**
```bash
# 1. 服务器信息
服务器IP: ___________________
SSH用户名: _________________
SSH密码: ___________________

# 2. 代理服务器信息
代理地址: http://proxy-server:port
代理用户名: _________________ (如果需要认证)
代理密码: ___________________ (如果需要认证)

# 3. 数据库信息 (已配置好的固定值)
数据库主机: _________________  # 您需要提供
数据库用户: dmp_rnd_xa        # 固定值
数据库密码: _________________  # 您需要提供
数据库端口: 8000              # 固定值
数据库名: datalake            # 固定值
模式名: dm_rnd_xa_export      # 固定值
源表名: mid_pc_yoyo_qa_641000052  # 固定值

# 4. 外部API信息 (可选)
分类API地址: _______________
分类API密钥: _______________
AI生成API地址: _____________
AI生成API密钥: _____________
```

## 🎯 **完整部署流程 (约30分钟)**

### **阶段一：连接服务器和环境准备 (5分钟)**

#### **步骤1: SSH连接到服务器**
```bash
# 1.1 连接到公司服务器
ssh 您的用户名@您的服务器IP

# 预期结果：成功登录到服务器
# 看到类似：username@hostname:~$
```

#### **步骤2: 检查系统环境**
```bash
# 2.1 检查系统版本
cat /etc/os-release

# 预期结果：显示Ubuntu 18.04信息
# NAME="Ubuntu"
# VERSION="18.04.x LTS (Bionic Beaver)"

# 2.2 检查可用空间
df -h

# 预期结果：根分区至少有20GB可用空间
# /dev/sda1  50G  25G  23G  53% /

# 2.3 检查内存
free -h

# 预期结果：至少4GB内存
# Mem:  8.0Gi  2.1Gi  4.2Gi
```

### **阶段二：配置代理环境 (5分钟)**

#### **步骤3: 设置临时代理**
```bash
# 3.1 设置代理环境变量 (替换为您的代理地址)
export http_proxy=http://您的代理地址:端口
export https_proxy=http://您的代理地址:端口

# 3.2 验证代理设置
echo $http_proxy
echo $https_proxy

# 预期结果：显示您设置的代理地址
# http://proxy-server:port

# 3.3 测试代理连接
curl -I --connect-timeout 10 https://www.google.com

# 预期结果：返回HTTP响应头
# HTTP/2 200
# content-type: text/html; charset=ISO-8859-1
```

#### **步骤4: 配置Git代理**
```bash
# 4.1 配置Git代理
git config --global http.proxy http://您的代理地址:端口
git config --global https.proxy http://您的代理地址:端口

# 4.2 验证Git配置
git config --global --get http.proxy
git config --global --get https.proxy

# 预期结果：显示代理配置
# http://proxy-server:port
```

### **阶段三：下载项目代码 (3分钟)**

#### **步骤5: 克隆项目**
```bash
# 5.1 克隆项目代码
git clone https://github.com/duanxingchao/ai-qa-platform.git

# 预期结果：成功克隆项目
# Cloning into 'ai-qa-platform'...
# remote: Enumerating objects: xxx, done.
# Receiving objects: 100% (xxx/xxx), done.

# 5.2 进入项目目录
cd ai-qa-platform

# 5.3 确认文件存在
ls -la quick-deploy-with-proxy.sh docker-compose.ubuntu18.yml

# 预期结果：显示部署脚本和配置文件
# -rwxr-xr-x 1 user user  xxxx quick-deploy-with-proxy.sh
# -rw-r--r-- 1 user user  xxxx docker-compose.ubuntu18.yml
```

### **阶段四：一键自动部署 (15分钟)**

#### **步骤6: 运行快速部署脚本**
```bash
# 6.1 给脚本执行权限
chmod +x quick-deploy-with-proxy.sh

# 6.2 运行部署脚本
./quick-deploy-with-proxy.sh

# 预期交互过程：
```

**部署脚本交互过程：**
```bash
# 交互1: 代理配置
请输入代理服务器地址 (格式: http://proxy-server:port): 
# 输入: http://您的代理地址:端口

代理服务器是否需要用户名密码认证? (y/n): 
# 输入: y 或 n

# 如果需要认证：
请输入用户名: 您的用户名
请输入密码: ******** (不显示)

# 交互2: 数据库配置
请输入数据库主机地址: 
# 输入: 您的数据库主机地址

请输入数据库密码: 
# 输入: ******** (不显示)

# 交互3: API配置
是否配置外部API? (y/n): 
# 输入: y (如果有真实API) 或 n (使用Mock服务)

# 如果选择y：
请输入分类API地址: 您的分类API地址
请输入分类API密钥: 您的分类API密钥
请输入AI生成API地址: 您的AI生成API地址
请输入AI生成API密钥: 您的AI生成API密钥
```

### **阶段五：部署过程监控和验证 (2分钟)**

#### **步骤7: 监控部署进度**
```bash
# 部署脚本会自动执行以下步骤，您可以看到进度：

# 7.1 代理环境配置
# 预期输出：
# ✅ 代理环境配置完成

# 7.2 系统兼容性检查
# 预期输出：
# ✅ 系统兼容性检查通过

# 7.3 Docker环境安装
# 预期输出：
# ✅ Docker安装完成
# ✅ Docker Compose安装完成

# 7.4 项目环境配置
# 预期输出：
# ✅ 项目环境配置完成

# 7.5 数据库连接测试
# 预期输出：
# ✅ 数据库连接测试成功

# 7.6 Docker服务构建和启动
# 预期输出：
# ✅ Docker服务构建和启动成功

# 7.7 数据库初始化
# 预期输出：
# ✅ 数据库表创建完成
```

#### **步骤8: 验证部署成功**
```bash
# 8.1 检查容器状态
docker-compose -f docker-compose.ubuntu18.yml ps

# 预期结果：所有容器状态为"Up"
# NAME                     STATUS
# qa-platform-backend      Up 2 minutes
# qa-platform-frontend     Up 2 minutes
# qa-platform-redis        Up 2 minutes
# qa-platform-prometheus   Up 2 minutes

# 8.2 测试后端API
curl http://localhost:18088/api/health

# 预期结果：返回健康状态
# {"status": "healthy"}

# 8.3 测试前端服务
curl http://localhost:18080/health

# 预期结果：返回健康状态
# healthy

# 8.4 获取服务器IP
hostname -I

# 预期结果：显示服务器IP地址
# 192.168.1.100
```

## 🌐 **访问系统**

### **步骤9: 浏览器访问**
```bash
# 9.1 在浏览器中访问
前端页面: http://您的服务器IP:18080
后端API文档: http://您的服务器IP:18088/docs

# 9.2 默认登录信息
用户名: admin
密码: admin123

# 预期结果：
# - 前端页面正常加载
# - 可以使用admin/admin123登录
# - 系统功能正常使用
```

## 🔍 **部署后验证清单**

### **功能验证**
```bash
# 1. 数据同步功能测试
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.services.sync_service import SyncService
app = create_app()
with app.app_context():
    sync = SyncService()
    status = sync.get_sync_status()
    print('同步状态:', status)
"

# 预期结果：显示同步状态信息
# 同步状态: {'last_sync_time': '2024-xx-xx', 'total_synced': 0}

# 2. 数据库连接验证
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
from sqlalchemy import text
app = create_app()
with app.app_context():
    result = db.session.execute(text('SELECT COUNT(*) FROM dm_rnd_xa_export.mid_pc_yoyo_qa_641000052')).scalar()
    print(f'源表记录数: {result}')
"

# 预期结果：显示源表记录数
# 源表记录数: 12345

# 3. 表创建验证
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    tables = db.engine.table_names()
    print('创建的表:', [t for t in tables if t in ['questions', 'answers', 'users', 'scores']])
"

# 预期结果：显示创建的表
# 创建的表: ['questions', 'answers', 'users', 'scores']
```

## ✅ **部署成功标志**

当您看到以下所有结果时，说明部署完全成功：

1. ✅ 所有Docker容器状态为"Up"
2. ✅ `curl http://localhost:18088/api/health` 返回 `{"status": "healthy"}`
3. ✅ `curl http://localhost:18080/health` 返回 `healthy`
4. ✅ 浏览器可以访问 `http://您的服务器IP:18080`
5. ✅ 可以使用admin/admin123登录系统
6. ✅ 数据库连接测试通过
7. ✅ 源表可以正常访问
8. ✅ 项目表创建成功

## 🚨 **常见问题快速解决**

### **问题1: 代理连接失败**
```bash
# 症状：curl连接超时或失败
# 检查代理配置
echo $http_proxy
echo $https_proxy

# 测试代理连接
curl -I --connect-timeout 10 --proxy "$http_proxy" https://www.google.com

# 预期结果：返回HTTP/2 200
# 如果失败，检查代理地址格式

# 解决方案：
# 1. 重新配置代理
export http_proxy=http://正确的代理地址:端口
export https_proxy=http://正确的代理地址:端口

# 2. 如果需要认证，格式为：
export http_proxy=http://用户名:密码@代理地址:端口

# 3. 重新运行部署脚本
./quick-deploy-with-proxy.sh
```

### **问题2: Docker镜像下载失败**
```bash
# 症状：docker pull失败或超时
# 检查Docker代理配置
sudo cat /etc/docker/daemon.json

# 预期内容：包含代理配置
# {
#   "proxies": {
#     "default": {
#       "httpProxy": "http://proxy:port"
#     }
#   }
# }

# 解决方案：
# 1. 重启Docker服务
sudo systemctl daemon-reload
sudo systemctl restart docker

# 2. 手动拉取镜像测试
docker pull hello-world

# 3. 重新构建服务
docker-compose -f docker-compose.ubuntu18.yml down
docker-compose -f docker-compose.ubuntu18.yml up -d --build
```

### **问题3: 数据库连接失败**
```bash
# 症状：数据库连接测试失败
# 1. 测试网络连通性
telnet 数据库主机 8000
# 预期结果：Connected to 数据库主机

# 2. 测试数据库认证
docker run --rm postgres:13 psql "postgresql://dmp_rnd_xa:密码@数据库主机:8000/datalake" -c "SELECT version();"
# 预期结果：显示PostgreSQL版本信息

# 3. 测试Schema访问
docker run --rm postgres:13 psql "postgresql://dmp_rnd_xa:密码@数据库主机:8000/datalake" -c "SELECT COUNT(*) FROM dm_rnd_xa_export.mid_pc_yoyo_qa_641000052;"
# 预期结果：显示记录数

# 解决方案：
# 1. 确认数据库主机地址正确
# 2. 确认端口8000可访问
# 3. 确认用户名密码正确
# 4. 确认有Schema访问权限
# 5. 联系数据库管理员确认权限
```

### **问题4: 端口被占用**
```bash
# 症状：端口绑定失败
# 检查端口占用
netstat -tuln | grep :18080
netstat -tuln | grep :18088

# 预期结果：如果端口被占用会显示进程信息
# tcp 0 0 0.0.0.0:18080 0.0.0.0:* LISTEN

# 查看占用进程
sudo lsof -i :18080
sudo lsof -i :18088

# 解决方案：
# 1. 停止占用进程
sudo kill -9 进程ID

# 2. 或者修改端口配置
# 编辑 docker-compose.ubuntu18.yml
# 将 "18080:80" 改为 "28080:80"
# 将 "18088:8088" 改为 "28088:8088"

# 3. 重新启动服务
docker-compose -f docker-compose.ubuntu18.yml down
docker-compose -f docker-compose.ubuntu18.yml up -d
```

### **问题5: 容器启动失败**
```bash
# 症状：docker-compose ps显示容器Exit状态
# 查看容器日志
docker-compose -f docker-compose.ubuntu18.yml logs backend
docker-compose -f docker-compose.ubuntu18.yml logs frontend

# 常见错误和解决方案：
# 1. 数据库连接错误
# 检查.env文件中的DATABASE_URL配置

# 2. 权限错误
# 确保当前用户在docker组中
sudo usermod -aG docker $USER
newgrp docker

# 3. 内存不足
# 检查系统内存使用
free -h
# 如果内存不足，关闭其他服务或增加内存

# 4. 重新构建容器
docker-compose -f docker-compose.ubuntu18.yml down
docker-compose -f docker-compose.ubuntu18.yml up -d --build --force-recreate
```

### **问题6: 前端页面无法访问**
```bash
# 症状：浏览器无法打开前端页面
# 1. 检查前端容器状态
docker-compose -f docker-compose.ubuntu18.yml ps frontend

# 2. 检查前端容器日志
docker-compose -f docker-compose.ubuntu18.yml logs frontend

# 3. 测试前端服务
curl http://localhost:18080/health
# 预期结果：healthy

# 4. 检查防火墙设置
sudo ufw status
# 如果防火墙开启，需要开放端口
sudo ufw allow 18080
sudo ufw allow 18088

# 5. 检查服务器IP
hostname -I
# 确认使用正确的IP访问
```

## 📚 **常用运维命令参考**

### **服务管理命令**
```bash
# 查看所有容器状态
docker-compose -f docker-compose.ubuntu18.yml ps

# 查看容器日志
docker-compose -f docker-compose.ubuntu18.yml logs
docker-compose -f docker-compose.ubuntu18.yml logs backend
docker-compose -f docker-compose.ubuntu18.yml logs frontend

# 重启服务
docker-compose -f docker-compose.ubuntu18.yml restart
docker-compose -f docker-compose.ubuntu18.yml restart backend

# 停止服务
docker-compose -f docker-compose.ubuntu18.yml down

# 启动服务
docker-compose -f docker-compose.ubuntu18.yml up -d

# 重新构建并启动
docker-compose -f docker-compose.ubuntu18.yml up -d --build
```

### **数据库操作命令**
```bash
# 进入后端容器执行数据库操作
docker-compose -f docker-compose.ubuntu18.yml exec backend bash

# 在容器内执行Python命令
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    # 您的数据库操作代码
    pass
"

# 手动触发数据同步
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.services.sync_service import SyncService
app = create_app()
with app.app_context():
    sync = SyncService()
    result = sync.sync_data()
    print('同步结果:', result)
"
```

### **系统监控命令**
```bash
# 查看系统资源使用
docker stats

# 查看磁盘使用
df -h

# 查看内存使用
free -h

# 查看网络连接
netstat -tuln | grep :18080
netstat -tuln | grep :18088

# 查看进程
ps aux | grep docker
```

### **日志查看命令**
```bash
# 实时查看日志
docker-compose -f docker-compose.ubuntu18.yml logs -f

# 查看最近100行日志
docker-compose -f docker-compose.ubuntu18.yml logs --tail=100

# 查看特定时间的日志
docker-compose -f docker-compose.ubuntu18.yml logs --since="2024-01-01T00:00:00"

# 导出日志到文件
docker-compose -f docker-compose.ubuntu18.yml logs > system.log
```

## 🎉 **部署完成**

**恭喜！您的智能问答系统已成功部署！**

### **访问地址**
- 🌐 **前端页面**：`http://您的服务器IP:18080`
- 🔌 **后端API**：`http://您的服务器IP:18088`
- 📖 **API文档**：`http://您的服务器IP:18088/docs`
- 📊 **监控面板**：`http://您的服务器IP:19090`

### **登录信息**
- 👤 **默认账号**：admin
- 🔑 **默认密码**：admin123

### **系统功能**
- ✅ 从源表 `dm_rnd_xa_export.mid_pc_yoyo_qa_641000052` 自动同步数据
- ✅ 智能问答分类和处理
- ✅ 完整的Web界面和API服务
- ✅ 用户管理和权限控制
- ✅ 数据统计和监控
- ✅ 支持代理环境运行

### **下一步操作建议**
1. **登录系统**：使用admin/admin123登录前端页面
2. **查看数据**：检查数据同步状态和问答数据
3. **配置用户**：根据需要添加其他用户账号
4. **API测试**：使用API文档测试各项功能
5. **监控运行**：定期检查系统运行状态

**技术支持**：如有问题，请查看上述故障排除指南或联系技术支持。
