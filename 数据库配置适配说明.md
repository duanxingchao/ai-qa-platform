# ğŸ—„ï¸ æ•°æ®åº“é…ç½®é€‚é…è¯´æ˜

## ğŸ“‹ **æ‚¨çš„æ•°æ®åº“é…ç½®ä¿¡æ¯**

### **æ•°æ®åº“è¿æ¥ä¿¡æ¯**
```bash
ç”¨æˆ·å: dmp_rnd_xa
ä¸»æœºåœ°å€: éƒ¨ç½²æ—¶è¾“å…¥
ç«¯å£: 8000
æ•°æ®åº“å: datalake
æ¨¡å¼å: dm_rnd_xa_export
æºè¡¨å: mid_pc_yoyo_qa_641000052
```

### **å­—æ®µæ˜ å°„å…³ç³»**
```bash
æºè¡¨å­—æ®µ â†’ é¡¹ç›®å­—æ®µ
query â†’ query1 (å…¶ä»–å­—æ®µåä¿æŒä¸å˜)
æ‰€æœ‰å­—æ®µç±»å‹: VARCHAR
```

## ğŸ”§ **å·²å®Œæˆçš„ä»£ç é€‚é…**

### **1. é…ç½®æ–‡ä»¶ä¿®æ”¹**
- âœ… `backend/app/config.py` - æ·»åŠ Schemaå’Œæºè¡¨é…ç½®
- âœ… é»˜è®¤Schema: `dm_rnd_xa_export`
- âœ… é»˜è®¤æºè¡¨: `mid_pc_yoyo_qa_641000052`

### **2. æ‰€æœ‰æ¨¡å‹æ–‡ä»¶Schemaé…ç½®**
- âœ… `backend/app/models/question.py` - æ·»åŠ Schemaé…ç½®
- âœ… `backend/app/models/answer.py` - æ·»åŠ Schemaé…ç½®
- âœ… `backend/app/models/user.py` - æ·»åŠ Schemaé…ç½®
- âœ… `backend/app/models/score.py` - æ·»åŠ Schemaé…ç½®
- âœ… `backend/app/models/review.py` - æ·»åŠ Schemaé…ç½®
- âœ… `backend/app/models/reclassification.py` - æ·»åŠ Schemaé…ç½®
- âœ… `backend/app/models/system_config.py` - æ·»åŠ Schemaé…ç½®

### **3. æ•°æ®åŒæ­¥æœåŠ¡é€‚é…**
- âœ… `backend/app/services/sync_service.py` - SQLæŸ¥è¯¢é€‚é…
- âœ… è¡¨åå¼•ç”¨: `dm_rnd_xa_export.mid_pc_yoyo_qa_641000052`
- âœ… å­—æ®µæ˜ å°„: `query` â†’ `query1`
- âœ… ç»Ÿè®¡æŸ¥è¯¢é€‚é…

### **4. æ•°æ®åº“åˆå§‹åŒ–**
- âœ… `backend/app/utils/database.py` - æ·»åŠ Schemaè·¯å¾„è®¾ç½®
- âœ… è‡ªåŠ¨è®¾ç½® `search_path` åˆ°æŒ‡å®šSchema

### **5. éƒ¨ç½²è„šæœ¬æ›´æ–°**
- âœ… `quick-deploy-with-proxy.sh` - æ·»åŠ æ•°æ®åº“é…ç½®è¯¢é—®
- âœ… å®‰å…¨çš„å¯†ç è¾“å…¥ (ä¸æ˜¾ç¤ºåœ¨å±å¹•ä¸Š)
- âœ… è‡ªåŠ¨æ„å»ºè¿æ¥å­—ç¬¦ä¸²

### **6. å­—æ®µç±»å‹ç»Ÿä¸€**
- âœ… æ‰€æœ‰æ¨¡å‹å­—æ®µç±»å‹æ”¹ä¸ºVARCHAR
- âœ… é€‚é…æºè¡¨çš„VARCHARç±»å‹
- âœ… ä¿æŒæ•°æ®ç±»å‹ä¸€è‡´æ€§

## ğŸ¯ **æ•°æ®åŒæ­¥æµç¨‹**

### **æºè¡¨åˆ°ç›®æ ‡è¡¨çš„å­—æ®µæ˜ å°„**
```sql
-- ä»æºè¡¨è¯»å–
SELECT 
    pageid,
    devicetypename, 
    sendmessagetime,
    query1,           -- æ³¨æ„ï¼šæºè¡¨å­—æ®µä¸ºquery1
    answer,
    serviceid,
    qatype,
    intent,
    iskeyboardinput,
    isstopanswer
FROM dm_rnd_xa_export.mid_pc_yoyo_qa_641000052

-- å†™å…¥ç›®æ ‡è¡¨
INSERT INTO dm_rnd_xa_export.questions (
    business_id,      -- MD5(pageid + sendmessagetime + query1)
    pageid,
    devicetypename,
    sendmessagetime,
    query,            -- å­˜å‚¨query1çš„å€¼
    serviceid,
    qatype,
    intent,
    iskeyboardinput,
    isstopanswer,
    classification    -- åˆå§‹ä¸ºNULLï¼Œç­‰å¾…AIå¤„ç†
)
```

### **æ•°æ®å¤„ç†é€»è¾‘**
1. **Business IDç”Ÿæˆ**: `MD5(pageid + sendmessagetime + query1)`
2. **æ•°æ®è¿‡æ»¤**: è¿‡æ»¤ç©ºçš„query1è®°å½•
3. **æ—¶é—´çª—å£**: åªåŒæ­¥æœ¬å‘¨æ•°æ®
4. **å»é‡æœºåˆ¶**: åŸºäºbusiness_idé¿å…é‡å¤
5. **åˆ†è¡¨å­˜å‚¨**: questionså’Œanswersåˆ†åˆ«å­˜å‚¨

## ğŸš€ **éƒ¨ç½²æµç¨‹**

### **éƒ¨ç½²æ—¶çš„äº¤äº’**
```bash
# è¿è¡Œéƒ¨ç½²è„šæœ¬
./quick-deploy-with-proxy.sh

# è„šæœ¬ä¼šè¯¢é—®ï¼š
è¯·è¾“å…¥ä»£ç†æœåŠ¡å™¨åœ°å€: http://proxy-server:port
ä»£ç†æœåŠ¡å™¨æ˜¯å¦éœ€è¦ç”¨æˆ·åå¯†ç è®¤è¯? (y/n): 
è¯·è¾“å…¥æ•°æ®åº“ä¸»æœºåœ°å€: æ‚¨çš„æ•°æ®åº“ä¸»æœº
è¯·è¾“å…¥æ•°æ®åº“å¯†ç : ******** (ä¸æ˜¾ç¤º)
æ˜¯å¦é…ç½®å¤–éƒ¨API? (y/n): 
```

### **è‡ªåŠ¨ç”Ÿæˆçš„è¿æ¥å­—ç¬¦ä¸²**
```bash
DATABASE_URL=postgresql://dmp_rnd_xa:æ‚¨çš„å¯†ç @æ‚¨çš„ä¸»æœº:8000/datalake
DATABASE_SCHEMA=dm_rnd_xa_export
SOURCE_TABLE_NAME=mid_pc_yoyo_qa_641000052
```

## ğŸ“Š **æ•°æ®åº“è¡¨ç»“æ„**

### **questionsè¡¨ (é¡¹ç›®ä¸»è¡¨)**
```sql
CREATE TABLE dm_rnd_xa_export.questions (
    id SERIAL PRIMARY KEY,
    business_id VARCHAR(64) UNIQUE NOT NULL,
    pageid VARCHAR(255),
    devicetypename VARCHAR(255),
    query VARCHAR(4000) NOT NULL,
    sendmessagetime VARCHAR(255),
    classification VARCHAR(255),
    serviceid VARCHAR(255),
    qatype VARCHAR(255),
    intent VARCHAR(255),
    iskeyboardinput VARCHAR(255) DEFAULT 'false',
    isstopanswer VARCHAR(255) DEFAULT 'false',
    -- å…¶ä»–ç®¡ç†å­—æ®µ...
);
```

### **answersè¡¨ (ç­”æ¡ˆè¡¨)**
```sql
CREATE TABLE dm_rnd_xa_export.answers (
    id SERIAL PRIMARY KEY,
    question_business_id VARCHAR(64) NOT NULL,
    assistant_type VARCHAR(255) NOT NULL DEFAULT 'yoyo',
    answer_text VARCHAR(4000),
    answer_time VARCHAR(255),
    is_scored VARCHAR(255) DEFAULT 'false',
    -- å…¶ä»–ç®¡ç†å­—æ®µ...
);
```

## âœ… **éªŒè¯æ¸…å•**

### **éƒ¨ç½²å‰éªŒè¯**
- [ ] æ•°æ®åº“è¿æ¥ä¿¡æ¯æ­£ç¡®
- [ ] æœ‰Schemaè®¿é—®æƒé™
- [ ] æœ‰è¡¨åˆ›å»ºæƒé™
- [ ] æºè¡¨å­˜åœ¨ä¸”å¯è®¿é—®

### **éƒ¨ç½²åéªŒè¯**
```bash
# 1. æ£€æŸ¥è¡¨åˆ›å»º
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    print('Tables:', db.engine.table_names())
"

# 2. æµ‹è¯•æ•°æ®åŒæ­¥
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.services.sync_service import SyncService
app = create_app()
with app.app_context():
    sync = SyncService()
    status = sync.get_sync_status()
    print('Sync status:', status)
"

# 3. éªŒè¯æºè¡¨è®¿é—®
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
from sqlalchemy import text
app = create_app()
with app.app_context():
    result = db.session.execute(text('SELECT COUNT(*) FROM dm_rnd_xa_export.mid_pc_yoyo_qa_641000052')).scalar()
    print(f'Source table count: {result}')
"
```

## ğŸš¨ **æ³¨æ„äº‹é¡¹**

### **å­—æ®µç±»å‹å˜æ›´å½±å“**
- æ—¶é—´å­—æ®µç°åœ¨æ˜¯VARCHARï¼Œéœ€è¦åœ¨åº”ç”¨å±‚å¤„ç†æ—¶é—´æ ¼å¼è½¬æ¢
- å¸ƒå°”å­—æ®µç°åœ¨æ˜¯VARCHAR ('true'/'false')ï¼Œéœ€è¦å­—ç¬¦ä¸²æ¯”è¾ƒ
- æ•°å€¼è®¡ç®—éœ€è¦å…ˆè½¬æ¢ç±»å‹

### **Schemaæƒé™è¦æ±‚**
- ç¡®ä¿ç”¨æˆ·å¯¹ `dm_rnd_xa_export` Schemaæœ‰å®Œæ•´è®¿é—®æƒé™
- ç¡®ä¿å¯ä»¥åˆ›å»ºè¡¨ã€ç´¢å¼•ç­‰å¯¹è±¡
- ç¡®ä¿å¯ä»¥è¯»å–æºè¡¨æ•°æ®

### **æ•°æ®åŒæ­¥æ³¨æ„**
- æºè¡¨å­—æ®µ `query1` æ˜ å°„åˆ°ç›®æ ‡è¡¨å­—æ®µ `query`
- æ‰€æœ‰æ•°æ®ç±»å‹ç»Ÿä¸€ä¸ºVARCHARï¼Œä¿æŒä¸æºè¡¨ä¸€è‡´
- ä¸šåŠ¡é€»è¾‘ä¸­çš„ç±»å‹è½¬æ¢éœ€è¦é€‚é…

ç°åœ¨æ‚¨çš„é¡¹ç›®å·²å®Œå…¨é€‚é…æ‚¨çš„æ•°æ®åº“ç¯å¢ƒï¼Œå¯ä»¥ç›´æ¥éƒ¨ç½²ä½¿ç”¨ï¼ ğŸ‰
