# 🗄️ 数据库配置适配说明

## 📋 **您的数据库配置信息**

### **数据库连接信息**
```bash
用户名: dmp_rnd_xa
主机地址: 部署时输入
端口: 8000
数据库名: datalake
模式名: dm_rnd_xa_export
源表名: mid_pc_yoyo_qa_641000052
```

### **字段映射关系**
```bash
源表字段 → 项目字段
query → query1 (其他字段名保持不变)
所有字段类型: VARCHAR
```

## 🔧 **已完成的代码适配**

### **1. 配置文件修改**
- ✅ `backend/app/config.py` - 添加Schema和源表配置
- ✅ 默认Schema: `dm_rnd_xa_export`
- ✅ 默认源表: `mid_pc_yoyo_qa_641000052`

### **2. 所有模型文件Schema配置**
- ✅ `backend/app/models/question.py` - 添加Schema配置
- ✅ `backend/app/models/answer.py` - 添加Schema配置
- ✅ `backend/app/models/user.py` - 添加Schema配置
- ✅ `backend/app/models/score.py` - 添加Schema配置
- ✅ `backend/app/models/review.py` - 添加Schema配置
- ✅ `backend/app/models/reclassification.py` - 添加Schema配置
- ✅ `backend/app/models/system_config.py` - 添加Schema配置

### **3. 数据同步服务适配**
- ✅ `backend/app/services/sync_service.py` - SQL查询适配
- ✅ 表名引用: `dm_rnd_xa_export.mid_pc_yoyo_qa_641000052`
- ✅ 字段映射: `query` → `query1`
- ✅ 统计查询适配

### **4. 数据库初始化**
- ✅ `backend/app/utils/database.py` - 添加Schema路径设置
- ✅ 自动设置 `search_path` 到指定Schema

### **5. 部署脚本更新**
- ✅ `quick-deploy-with-proxy.sh` - 添加数据库配置询问
- ✅ 安全的密码输入 (不显示在屏幕上)
- ✅ 自动构建连接字符串

### **6. 字段类型统一**
- ✅ 所有模型字段类型改为VARCHAR
- ✅ 适配源表的VARCHAR类型
- ✅ 保持数据类型一致性

## 🎯 **数据同步流程**

### **源表到目标表的字段映射**
```sql
-- 从源表读取
SELECT 
    pageid,
    devicetypename, 
    sendmessagetime,
    query1,           -- 注意：源表字段为query1
    answer,
    serviceid,
    qatype,
    intent,
    iskeyboardinput,
    isstopanswer
FROM dm_rnd_xa_export.mid_pc_yoyo_qa_641000052

-- 写入目标表
INSERT INTO dm_rnd_xa_export.questions (
    business_id,      -- MD5(pageid + sendmessagetime + query1)
    pageid,
    devicetypename,
    sendmessagetime,
    query,            -- 存储query1的值
    serviceid,
    qatype,
    intent,
    iskeyboardinput,
    isstopanswer,
    classification    -- 初始为NULL，等待AI处理
)
```

### **数据处理逻辑**
1. **Business ID生成**: `MD5(pageid + sendmessagetime + query1)`
2. **数据过滤**: 过滤空的query1记录
3. **时间窗口**: 只同步本周数据
4. **去重机制**: 基于business_id避免重复
5. **分表存储**: questions和answers分别存储

## 🚀 **部署流程**

### **部署时的交互**
```bash
# 运行部署脚本
./quick-deploy-with-proxy.sh

# 脚本会询问：
请输入代理服务器地址: http://proxy-server:port
代理服务器是否需要用户名密码认证? (y/n): 
请输入数据库主机地址: 您的数据库主机
请输入数据库密码: ******** (不显示)
是否配置外部API? (y/n): 
```

### **自动生成的连接字符串**
```bash
DATABASE_URL=postgresql://dmp_rnd_xa:您的密码@您的主机:8000/datalake
DATABASE_SCHEMA=dm_rnd_xa_export
SOURCE_TABLE_NAME=mid_pc_yoyo_qa_641000052
```

## 📊 **数据库表结构**

### **questions表 (项目主表)**
```sql
CREATE TABLE dm_rnd_xa_export.questions (
    id SERIAL PRIMARY KEY,
    business_id VARCHAR(64) UNIQUE NOT NULL,
    pageid VARCHAR(255),
    devicetypename VARCHAR(255),
    query VARCHAR(4000) NOT NULL,
    sendmessagetime VARCHAR(255),
    classification VARCHAR(255),
    serviceid VARCHAR(255),
    qatype VARCHAR(255),
    intent VARCHAR(255),
    iskeyboardinput VARCHAR(255) DEFAULT 'false',
    isstopanswer VARCHAR(255) DEFAULT 'false',
    -- 其他管理字段...
);
```

### **answers表 (答案表)**
```sql
CREATE TABLE dm_rnd_xa_export.answers (
    id SERIAL PRIMARY KEY,
    question_business_id VARCHAR(64) NOT NULL,
    assistant_type VARCHAR(255) NOT NULL DEFAULT 'yoyo',
    answer_text VARCHAR(4000),
    answer_time VARCHAR(255),
    is_scored VARCHAR(255) DEFAULT 'false',
    -- 其他管理字段...
);
```

## ✅ **验证清单**

### **部署前验证**
- [ ] 数据库连接信息正确
- [ ] 有Schema访问权限
- [ ] 有表创建权限
- [ ] 源表存在且可访问

### **部署后验证**
```bash
# 1. 检查表创建
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
app = create_app()
with app.app_context():
    print('Tables:', db.engine.table_names())
"

# 2. 测试数据同步
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.services.sync_service import SyncService
app = create_app()
with app.app_context():
    sync = SyncService()
    status = sync.get_sync_status()
    print('Sync status:', status)
"

# 3. 验证源表访问
docker-compose -f docker-compose.ubuntu18.yml exec backend python -c "
from app import create_app
from app.utils.database import db
from sqlalchemy import text
app = create_app()
with app.app_context():
    result = db.session.execute(text('SELECT COUNT(*) FROM dm_rnd_xa_export.mid_pc_yoyo_qa_641000052')).scalar()
    print(f'Source table count: {result}')
"
```

## 🚨 **注意事项**

### **字段类型变更影响**
- 时间字段现在是VARCHAR，需要在应用层处理时间格式转换
- 布尔字段现在是VARCHAR ('true'/'false')，需要字符串比较
- 数值计算需要先转换类型

### **Schema权限要求**
- 确保用户对 `dm_rnd_xa_export` Schema有完整访问权限
- 确保可以创建表、索引等对象
- 确保可以读取源表数据

### **数据同步注意**
- 源表字段 `query1` 映射到目标表字段 `query`
- 所有数据类型统一为VARCHAR，保持与源表一致
- 业务逻辑中的类型转换需要适配

现在您的项目已完全适配您的数据库环境，可以直接部署使用！ 🎉
